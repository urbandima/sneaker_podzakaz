# Диаграмма архитектурных проблем

## Текущая архитектура (проблемная)

```
┌─────────────────────────────────────────────────────────────┐
│                    CatalogController                         │
│                                                              │
│  ┌──────────────────┐        ┌──────────────────┐          │
│  │ getActiveFilters │        │ buildFilterUrl   │          │
│  │   (168 строк)    │        │   (24 строки)    │          │
│  └──────────────────┘        └──────────────────┘          │
│           │                           │                      │
│           │                           │                      │
└───────────┼───────────────────────────┼──────────────────────┘
            │                           │
            ▼                           ▼
    ┌───────────────┐          ┌────────────────┐
    │  SmartFilter  │          │ FilterBuilder  │
    │               │          │                │
    │ - formatActive│◄─────────┤ - buildFilters │
    │   Filters     │ ДУБЛЬ!   │ - applyFilters │
    │ - generateSef │          │ - buildBrands  │
    │   Url         │          │ - buildCateg.  │
    │ - parseSefUrl │          │ - buildChars   │
    │ - getCanonical│          │                │
    │ - getRobots   │          │                │
    └───────────────┘          └────────────────┘
            │                           │
            │                           │
            ▼                           ▼
    ┌───────────────────────────────────────────┐
    │              ПРОБЛЕМА:                    │
    │  Два компонента делают похожие вещи       │
    │  Дублирование логики formatActiveFilters  │
    │  Непонятно какой использовать             │
    └───────────────────────────────────────────┘
```

---

## Проблема гибридной системы характеристик

```
┌──────────────────────────────────────────────────────────────┐
│                         Product                              │
│                                                              │
│  Прямые поля:                  Связанные таблицы:           │
│  ┌──────────────┐              ┌──────────────────┐         │
│  │ gender       │              │ characteristic_  │         │
│  │ = 'male'     │◄────┐        │ value            │         │
│  │              │     │        │ id=11            │         │
│  │ season       │     │        │ value='Мужской'  │         │
│  │ = 'summer'   │     │        │ slug='male'      │         │
│  │              │     │        └──────────────────┘         │
│  │ material     │     │                 │                   │
│  │ = 'leather'  │     │                 │                   │
│  └──────────────┘     │                 ▼                   │
│                       │        ┌──────────────────┐         │
│                       │        │ product_         │         │
│                       │        │ characteristic_  │         │
│                       │        │ value            │         │
│                       │        │ product_id       │         │
│                       │        │ char_value_id=11 │         │
│                       │        └──────────────────┘         │
│                       │                                      │
│                       └──────────────────────────────────────┤
│                                ПРОБЛЕМА:                     │
│  Одни и те же данные в двух местах!                         │
│  'male' (строка) vs 11 (число)                              │
│  Нужна сложная логика конвертации                           │
└──────────────────────────────────────────────────────────────┘
```

---

## Логика фильтрации с проверкой типа

```
┌─────────────────────────────────────────────────────────────┐
│         FilterBuilder::applyFiltersToQuery()                │
│                                                             │
│  Фильтр: char_5 = ['male']                                 │
│           │                                                 │
│           ▼                                                 │
│  ┌──────────────────────────────────┐                      │
│  │ Проверка: is_numeric('male')?    │                      │
│  │ Результат: false                 │                      │
│  └──────────────────────────────────┘                      │
│           │                                                 │
│           ▼                                                 │
│  ┌──────────────────────────────────┐                      │
│  │ Это строка → используем напрямую │                      │
│  │ WHERE product.gender = 'male'    │                      │
│  └──────────────────────────────────┘                      │
│                                                             │
│  Фильтр: char_5 = [11]                                     │
│           │                                                 │
│           ▼                                                 │
│  ┌──────────────────────────────────┐                      │
│  │ Проверка: is_numeric(11)?        │                      │
│  │ Результат: true                  │                      │
│  └──────────────────────────────────┘                      │
│           │                                                 │
│           ▼                                                 │
│  ┌──────────────────────────────────┐                      │
│  │ Это число → конвертируем         │                      │
│  │ SELECT slug FROM char_value      │ ← Доп. запрос!      │
│  │ WHERE id = 11                    │                      │
│  │ → 'male'                         │                      │
│  │                                  │                      │
│  │ WHERE product.gender = 'male'    │                      │
│  └──────────────────────────────────┘                      │
│                                                             │
│  ПРОБЛЕМА: При каждой фильтрации выполняется:              │
│  1. Проверка типа (is_numeric)                             │
│  2. Дополнительный запрос к БД (если число)                │
│  3. N+1 проблема при множественных характеристиках         │
└─────────────────────────────────────────────────────────────┘
```

---

## Целевая архитектура (после рефакторинга)

```
┌─────────────────────────────────────────────────────────────┐
│                    CatalogController                         │
│                                                              │
│  ┌──────────────────────────────────────────────┐           │
│  │         Использует FilterService             │           │
│  └──────────────────────────────────────────────┘           │
│                        │                                     │
└────────────────────────┼─────────────────────────────────────┘
                         │
                         ▼
            ┌────────────────────────┐
            │    FilterService       │
            │  (единый сервис)       │
            │                        │
            │ - buildFilters()       │
            │ - applyFilters()       │
            │ - formatActive()       │
            │ - generateUrl()        │
            │ - parseUrl()           │
            │ - getCanonical()       │
            └────────────────────────┘
                         │
                         ▼
            ┌────────────────────────┐
            │   FilterConfig         │
            │  (конфигурация)        │
            │                        │
            │ - getLabels()          │
            │ - getValidValues()     │
            │ - getStorageType()     │
            └────────────────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │         Product                │
        │                                │
        │  БЕЗ прямых полей gender,      │
        │  season, material              │
        │                                │
        │  Только через:                 │
        │  characteristic_value +        │
        │  product_characteristic_value  │
        └────────────────────────────────┘

ПРЕИМУЩЕСТВА:
✅ Единая точка входа
✅ Нет дублирования
✅ Легко тестировать
✅ Легко расширять
✅ Понятная структура
```

---

## Сравнение подходов хранения характеристик

### Вариант А: Только characteristic_value (рекомендуется)

```
┌─────────────────────────────────────────────────────────────┐
│                         Product                              │
│  id | name                    | brand_id | category_id      │
│  1  | Nike Dunk Low          | 5        | 3                 │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│              product_characteristic_value                    │
│  product_id | characteristic_id | characteristic_value_id   │
│  1          | 5 (gender)        | 11 (Мужской)              │
│  1          | 6 (season)        | 21 (Лето)                 │
│  1          | 7 (material)      | 31 (Кожа)                 │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│              characteristic_value                            │
│  id | characteristic_id | value     | slug      | sort_order│
│  11 | 5                 | Мужской   | male      | 1         │
│  12 | 5                 | Женский   | female    | 2         │
│  13 | 5                 | Унисекс   | unisex    | 3         │
└─────────────────────────────────────────────────────────────┘

ПЛЮСЫ:
✅ Единая система хранения
✅ Гибкость (можно добавлять значения без миграций)
✅ Легко добавлять новые характеристики
✅ Поддержка множественных значений
✅ Сортировка и группировка

МИНУСЫ:
❌ Медленнее (JOIN с product_characteristic_value)
❌ Сложнее запросы
```

### Вариант Б: Только прямые поля

```
┌─────────────────────────────────────────────────────────────┐
│                         Product                              │
│  id | name            | gender | season | material          │
│  1  | Nike Dunk Low  | male   | summer | leather           │
└─────────────────────────────────────────────────────────────┘

ПЛЮСЫ:
✅ Быстрее (нет JOIN)
✅ Проще запросы
✅ Меньше таблиц

МИНУСЫ:
❌ Менее гибко (нужны миграции для новых значений)
❌ Не поддерживает множественные значения
❌ Жестко закодированные ENUM
❌ Сложно добавлять новые характеристики
```

---

## Метрики текущей архитектуры

```
┌──────────────────────────────────────────────────────────────┐
│                    МЕТРИКИ КОДА                              │
├──────────────────────────────────────────────────────────────┤
│ Дублирование:                                                │
│  - formatActiveFilters: 3 реализации (168 + 87 + ~50 строк) │
│  - URL generation: 2 реализации (65 + 24 строки)            │
│  - Итого дублирования: ~400 строк                           │
├──────────────────────────────────────────────────────────────┤
│ Сложность:                                                   │
│  - Циклическая сложность FilterBuilder: 8/10                │
│  - Глубина вложенности: до 5 уровней                        │
│  - Количество условий в applyFilters: 15+                   │
├──────────────────────────────────────────────────────────────┤
│ Производительность:                                          │
│  - Дополнительных запросов при фильтрации: 1-5              │
│  - Проверок типа на запрос: 10-20                           │
│  - Потенциальная N+1 проблема: Да                           │
├──────────────────────────────────────────────────────────────┤
│ Поддерживаемость:                                            │
│  - Связанность компонентов: Высокая                         │
│  - Когезия: Низкая                                          │
│  - Тестируемость: Средняя                                   │
└──────────────────────────────────────────────────────────────┘
```

---

## План миграции (поэтапный)

### Этап 1: Подготовка (1 день)
```
1. Создать резервную копию БД
2. Проанализировать данные в product (gender, season, material)
3. Проверить наличие данных в product_characteristic
4. Создать план миграции данных
```

### Этап 2: Рефакторинг FilterService (2-3 дня)
```
1. Создать services/Catalog/FilterService.php
2. Перенести методы из SmartFilter
3. Перенести методы из FilterBuilder
4. Объединить formatActiveFilters
5. Добавить тесты
```

### Этап 3: Миграция характеристик (3-4 дня)
```
1. Создать миграцию для переноса данных:
   product.gender → product_characteristic_value
2. Обновить FilterService для работы только с characteristic_value
3. Удалить поля gender, season, material из product
4. Обновить все запросы
5. Тестирование
```

### Этап 4: Очистка (1 день)
```
1. Удалить SmartFilter.php
2. Удалить дублирующие методы из CatalogController
3. Удалить старую таблицу product_characteristic
4. Обновить документацию
```

### Этап 5: Оптимизация (2 дня)
```
1. Добавить индексы для characteristic_value
2. Оптимизировать запросы фильтрации
3. Добавить кэширование
4. Провести нагрузочное тестирование
```

**Общее время:** 9-11 рабочих дней
