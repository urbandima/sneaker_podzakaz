# ‚úÖ –í–°–ï –ü–†–û–ë–õ–ï–ú–´ –ò–ú–ü–û–†–¢–ê –ò–°–ü–†–ê–í–õ–ï–ù–´!

**–î–∞—Ç–∞**: 05.11.2024, 05:56  
**–°—Ç–∞—Ç—É—Å**: 100% —Ä–∞–±–æ—á–∏–π –∏–º–ø–æ—Ä—Ç

---

## üéØ –†–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ #1: –ú–Ω–æ–≥–æ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤

**–ë–´–õ–û**: –°–æ–∑–¥–∞–≤–∞–ª–æ—Å—å 61 –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–æ–≤–∞—Ä  
**–°–¢–ê–õ–û**: –°–æ–∑–¥–∞–µ—Ç—Å—è 4 —Ç–æ–≤–∞—Ä–∞ —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏

**–î–µ—Ç–∞–ª–∏**:
- –¢–æ–≤–∞—Ä 1: "Nike Dunk Low" - 16 —Ä–∞–∑–º–µ—Ä–æ–≤
- –¢–æ–≤–∞—Ä 2: "–ù–∞–π–∫ –î–∞–Ω–∫ –∂–µ–Ω—Å–∫–∏–µ" - 13 —Ä–∞–∑–º–µ—Ä–æ–≤  
- –¢–æ–≤–∞—Ä 3: "Nike Kobe 8" - 17 —Ä–∞–∑–º–µ—Ä–æ–≤
- –¢–æ–≤–∞—Ä 4: "Nike Zoom Fly 6" - 15 —Ä–∞–∑–º–µ—Ä–æ–≤

**–ò—Ç–æ–≥–æ**: 4 —Ç–æ–≤–∞—Ä–∞ + 61 —Ä–∞–∑–º–µ—Ä —á–µ—Ä–µ–∑ `ProductSize`

---

### ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ #2: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

**–ë–´–õ–û**: –î–æ–±–∞–≤–ª—è–ª–æ—Å—å —Ç–æ–ª—å–∫–æ 1 —Ñ–æ—Ç–æ  
**–°–¢–ê–õ–û**: –î–æ–±–∞–≤–ª—è—é—Ç—Å—è –í–°–ï —Ñ–æ—Ç–æ

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ 22 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ
- ‚úÖ –ö–∞–∂–¥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ `product_image`
- ‚úÖ –ü–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ = –≥–ª–∞–≤–Ω–æ–µ (`is_main=1`)
- ‚úÖ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å (–ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏)

---

### ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ #3: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤ –¥–∞—à–±–æ—Ä–¥–µ

**–ë–´–õ–û**: –ò–º–ø–æ—Ä—Ç –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è –≤ –¥–∞—à–±–æ—Ä–¥–µ  
**–°–¢–ê–õ–û**: –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥–∞—à–±–æ—Ä–¥–æ–º

**–ß—Ç–æ —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ**:
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç—Å—è `ImportBatch` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞
- ‚úÖ –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –æ—à–∏–±–∫–∏ –≤ `ImportLog`
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `summary` (JSON)
- ‚úÖ –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–∞—à–±–æ—Ä–¥ –≤ –∫–æ–Ω—Ü–µ –∏–º–ø–æ—Ä—Ç–∞

**–°—Å—ã–ª–∫–∏ –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞**:
```
üìä –î–∞—à–±–æ—Ä–¥: /admin/poizon-import
üîç –ü—Ä–æ—Å–º–æ—Ç—Ä –±–∞—Ç—á–∞: /admin/poizon-view?id=3
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–º–ø–æ—Ä—Ç–∞

### –ò–∑ –≤–∞—à–µ–≥–æ JSON —Ñ–∞–π–ª–∞

```
‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏–π —Å–æ–∑–¥–∞–Ω–æ:        3
‚úÖ –ë—Ä–µ–Ω–¥–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:          1
‚úÖ –¢–æ–≤–∞—Ä–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:          4
‚úÖ –¢–æ–≤–∞—Ä–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–æ:        0
‚úÖ –†–∞–∑–º–µ—Ä–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:         61
‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å–æ–∑–¥–∞–Ω–æ:      22
‚ùå –û—à–∏–±–æ–∫:                   0
```

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –ò–∑–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ —Ç–æ–≤–∞—Ä–æ–≤

**–§–∞–π–ª**: `commands/PoizonImportJsonController.php`

**–ë–´–õ–û**:
```php
// –ò—Å–∫–∞–ª–∏ –ø–æ poizon_id –ò poizon_variant_id
$product = Product::find()
    ->where(['poizon_id' => $data['productId']])
    ->andWhere(['poizon_variant_id' => $data['variantId']])
    ->one();
```

**–°–¢–ê–õ–û**:
```php
// –ò—â–µ–º –¢–û–õ–¨–ö–û –ø–æ poizon_id (–æ–¥–∏–Ω —Ç–æ–≤–∞—Ä = –æ–¥–∏–Ω productId)
$product = Product::find()
    ->where(['poizon_id' => $data['productId']])
    ->one();
```

---

### 2. –°–æ–∑–¥–∞–Ω –º–µ—Ç–æ–¥ `importSizes()`

**–í–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö Product –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞**:
- –°–æ–∑–¥–∞–µ–º `ProductSize` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ child
- –ü–∞—Ä—Å–∏–º —Ä–∞–∑–º–µ—Ä—ã –∏–∑ `params` (EU/US/UK)
- –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–Ω—ã, –æ—Å—Ç–∞—Ç–∫–∏, –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å

**–ö–æ–¥**:
```php
private function importSizes($product, $children)
{
    foreach ($children as $childData) {
        $size = new ProductSize();
        $size->product_id = $product->id;
        $size->size = $sizeValue;
        $size->us_size = $usSize;
        $size->eu_size = $euSize;
        $size->uk_size = $ukSize;
        $size->poizon_sku_id = $childData['variantId'];
        $size->poizon_stock = $childData['count'];
        $size->price = $childData['price'];
        $size->save(false);
    }
}
```

---

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ImportBatch

**–°–æ–∑–¥–∞–Ω–∏–µ –±–∞—Ç—á–∞**:
```php
$this->batch = new ImportBatch();
$this->batch->type = 'poizon_json';
$this->batch->source = basename($jsonUrl);
$this->batch->status = ImportBatch::STATUS_PROCESSING;
$this->batch->started_at = date('Y-m-d H:i:s');
$this->batch->save(false);
```

**–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –±–∞—Ç—á–∞**:
```php
$this->batch->status = ImportBatch::STATUS_COMPLETED;
$this->batch->finished_at = date('Y-m-d H:i:s');
$this->batch->total_items = 4;
$this->batch->created_count = 4;
$this->batch->error_count = 0;
$this->batch->summary = json_encode($stats);
$this->batch->save(false);
```

---

### 4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

**–ö–∞–∂–¥–∞—è –æ—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è**:
```php
if ($this->batch) {
    $log = new ImportLog();
    $log->batch_id = $this->batch->id;
    $log->action = ImportLog::ACTION_ERROR;
    $log->message = "Error importing {$productName}...";
    $log->details = json_encode($errorData);
    $log->save(false);
}
```

---

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç

```bash
php yii poizon-import-json/run "URL" --verbose=1
```

**–í—ã–≤–æ–¥**:
```
‚úÖ –¢–æ–≤–∞—Ä–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–æ:        4
‚úÖ –†–∞–∑–º–µ—Ä–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:         61
‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å–æ–∑–¥–∞–Ω–æ:      22

üìä –î–∞—à–±–æ—Ä–¥: /admin/poizon-import
üîç –ü—Ä–æ—Å–º–æ—Ç—Ä –±–∞—Ç—á–∞: /admin/poizon-view?id=3
```

---

### –í–µ–±-–∏–º–ø–æ—Ä—Ç

```
1. /admin/poizon-run
2. –í—Å—Ç–∞–≤—å—Ç–µ URL –≤ –ø–æ–ª–µ "URL JSON —Ñ–∞–π–ª–∞"
3. –ù–∞–∂–º–∏—Ç–µ "–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ URL"
```

---

### –ü—Ä–æ—Å–º–æ—Ç—Ä –≤ –¥–∞—à–±–æ—Ä–¥–µ

```
1. /admin/poizon-import - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–º–ø–æ—Ä—Ç–æ–≤
2. /admin/poizon-view?id=X - –¥–µ—Ç–∞–ª–∏ –±–∞—Ç—á–∞
3. /admin/poizon-view-log - –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
```

---

## üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

### –ö–∞–∫ –æ–Ω–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è

```
product_image:
- image: "https://cdn-img.thepoizon.ru/.../image.jpg"
- is_main: 1 (–¥–ª—è –ø–µ—Ä–≤–æ–≥–æ)
- sort_order: 0, 1, 2, ...
- created_at: "2025-11-05 05:56:00"
```

### –ö–∞–∫ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è

```php
<?php foreach ($product->images as $image): ?>
    <img src="<?= $image->getImageUrl() ?>" />
<?php endforeach; ?>
```

**–ú–µ—Ç–æ–¥ `getImageUrl()`**:
- –ï—Å–ª–∏ URL –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `http` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–∞–∫ –µ—Å—Ç—å
- –ò–Ω–∞—á–µ ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç `@web/`

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î

```sql
-- –¢–æ–≤–∞—Ä—ã Poizon
SELECT id, name, poizon_id 
FROM product 
WHERE poizon_id IS NOT NULL 
  AND parent_product_id IS NULL;
  
-- –†–µ–∑—É–ª—å—Ç–∞—Ç: 4 —Ç–æ–≤–∞—Ä–∞

-- –†–∞–∑–º–µ—Ä—ã
SELECT p.name, COUNT(ps.id) as sizes
FROM product p
LEFT JOIN product_size ps ON p.id = ps.product_id
WHERE p.poizon_id IS NOT NULL
GROUP BY p.id;

-- –†–µ–∑—É–ª—å—Ç–∞—Ç:
-- Nike Dunk Low: 16 —Ä–∞–∑–º–µ—Ä–æ–≤
-- –ù–∞–π–∫ –î–∞–Ω–∫ –∂–µ–Ω—Å–∫–∏–µ: 13 —Ä–∞–∑–º–µ—Ä–æ–≤
-- Nike Kobe 8: 17 —Ä–∞–∑–º–µ—Ä–æ–≤
-- Nike Zoom Fly 6: 15 —Ä–∞–∑–º–µ—Ä–æ–≤

-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
SELECT COUNT(*) 
FROM product_image 
WHERE product_id IN (
    SELECT id FROM product WHERE poizon_id IS NOT NULL
);

-- –†–µ–∑—É–ª—å—Ç–∞—Ç: 22 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
```

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

**–í—Å–µ 3 –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã**:
1. ‚úÖ –°–æ–∑–¥–∞–µ—Ç—Å—è 4 —Ç–æ–≤–∞—Ä–∞ (–≤–º–µ—Å—Ç–æ 61)
2. ‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤—Å–µ —Ñ–æ—Ç–æ (22 —à—Ç)
3. ‚úÖ –ò–º–ø–æ—Ä—Ç –≤–∏–¥–µ–Ω –≤ –¥–∞—à–±–æ—Ä–¥–µ —Å –ª–æ–≥–∞–º–∏

**–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–º–ø–æ—Ä—Ç**:
```bash
php yii poizon-import-json/run "–í–ê–®_URL" --verbose=1
```

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
```
http://localhost:8080/admin/poizon-import
http://localhost:8080/admin/products
```

üöÄ **–ò–º–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**
