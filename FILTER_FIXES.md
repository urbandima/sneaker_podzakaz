# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤

**–î–∞—Ç–∞:** 2025-11-10  
**–ó–∞–¥–∞—á–∞:** –ù–∞–ª–∞–¥–∏—Ç—å —Ä–∞–±–æ—Ç—É —Ñ–∏–ª—å—Ç—Ä–∞ –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ –¥–ª—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ (–≤–∫–ª—é—á–∞—è –ø–æ–ª)

## –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚ùå CatalogController::actionFilter() - —Å—Ç—Ä–æ–∫–∞ 1890
**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ—Ç–æ–¥ `getFiltersData()` –≤—ã–∑—ã–≤–∞–ª—Å—è –±–µ–∑ –ø–µ—Ä–µ–¥–∞—á–∏ —Ç–µ–∫—É—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø–æ–¥—Å—á–µ—Ç—É —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫.

**–ë—ã–ª–æ:**
```php
$filters = $this->getFiltersData();
```

**–°—Ç–∞–ª–æ:**
```php
// –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–µ—Ä–µ–¥–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞
$filters = $this->getFiltersData($currentFilters);
```

---

### 2. ‚ùå CatalogController::getFiltersData() - —Å—Ç—Ä–æ–∫–∞ 1141
**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ—Ç–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–ª –ø–µ—Ä–µ–¥–∞—á—É –≥–æ—Ç–æ–≤—ã—Ö `currentFilters` –¥–ª—è AJAX –∑–∞–ø—Ä–æ—Å–æ–≤, –≤—Å–µ–≥–¥–∞ —á–∏—Ç–∞–ª –∏–∑ `$request->get()`.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞:
- –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –º–∞—Å—Å–∏–≤ —Å –∫–ª—é—á–∞–º–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (`brands`, `categories`, `sizes`) ‚Äî —ç—Ç–æ `currentFilters` (–¥–ª—è AJAX)
- –ò–Ω–∞—á–µ ‚Äî —ç—Ç–æ `baseCondition` (`brand_id`, `category_id`) –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–ö–æ–¥:**
```php
protected function getFiltersData($currentFiltersOrBaseCondition = [])
{
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —á—Ç–æ –ø–µ—Ä–µ–¥–∞–Ω–æ - currentFilters –∏–ª–∏ baseCondition
    $isCurrentFilters = isset($currentFiltersOrBaseCondition['brands']) || 
                       isset($currentFiltersOrBaseCondition['categories']) ||
                       isset($currentFiltersOrBaseCondition['sizes']) ||
                       isset($currentFiltersOrBaseCondition['price_from']);
    
    if ($isCurrentFilters) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã (–¥–ª—è AJAX)
        $currentFilters = $currentFiltersOrBaseCondition;
        $baseCondition = [];
    } else {
        // –ß–∏—Ç–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ request (–¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)
        $baseCondition = $currentFiltersOrBaseCondition;
        // ... —á–∏—Ç–∞–µ–º –∏–∑ request
    }
    
    return FilterBuilder::buildFilters($currentFilters, $baseCondition);
}
```

---

### 3. ‚ùå FilterBuilder::buildCharacteristicsFilters() - —Å—Ç—Ä–æ–∫–∞ 283
**–ü—Ä–æ–±–ª–µ–º–∞:** –í LEFT JOIN –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `rawSql` –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞, –∫–æ—Ç–æ—Ä—ã–π –º–æ–≥ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏ –ø–æ–¥—Å—á–µ—Ç–µ —Ç–æ–≤–∞—Ä–æ–≤ —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤.

**–ë—ã–ª–æ:**
```php
->leftJoin(
    ['pcv' => '{{%product_characteristic_value}}'],
    'pcv.characteristic_value_id = cv.id AND pcv.product_id IN (' . $productIdsQuery->createCommand()->rawSql . ')'
)
```

**–°—Ç–∞–ª–æ:**
```php
// –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–¥–∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ IN –≤–º–µ—Å—Ç–æ rawSql
$productIds = $productIdsQuery->select('id')->column();

if (empty($productIds)) {
    $allValues = [];
} else {
    $allValues = CharacteristicValue::find()
        // ...
        ->leftJoin(
            ['pcv' => '{{%product_characteristic_value}}'],
            'pcv.characteristic_value_id = cv.id AND pcv.product_id IN (' . implode(',', $productIds) . ')'
        )
        // ...
        ->all();
}
```

---

### 4. ‚ùå catalog.js::updateFilterCounts() - —Å—Ç—Ä–æ–∫–∞ 414
**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª—è–ª–∞ —Å—á–µ—Ç—á–∏–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –±—Ä–µ–Ω–¥–æ–≤ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –Ω–æ –Ω–µ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ (–ø–æ–ª, —Å–µ–∑–æ–Ω –∏ —Ç.–¥.).

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω –±–ª–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –¥–ª—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫:

```javascript
// –ù–û–í–û–ï: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ (–ø–æ–ª, —Å–µ–∑–æ–Ω –∏ —Ç.–¥.)
if (filters.characteristics) {
    filters.characteristics.forEach(characteristic => {
        const charId = characteristic.id;
        const charKey = 'char_' + charId;
        
        console.log(`üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: ${characteristic.name} (${charKey})`, characteristic);
        
        if (characteristic.values && Array.isArray(characteristic.values)) {
            characteristic.values.forEach(value => {
                const checkbox = document.querySelector(`input[name="${charKey}[]"][value="${value.id}"]`);
                if (checkbox) {
                    const countSpan = checkbox.closest('label').querySelector('.count');
                    if (countSpan) {
                        countSpan.textContent = value.count || 0;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ disabled
                    const label = checkbox.closest('label');
                    if (!value.count || value.count === 0) {
                        checkbox.disabled = true;
                        label.classList.add('disabled');
                    } else {
                        checkbox.disabled = false;
                        label.classList.remove('disabled');
                    }
                }
            });
        }
    });
}
```

---

## –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–í—Å–µ —Å—á–µ—Ç—á–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Ç–µ–ø–µ—Ä—å –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**, –≤–∫–ª—é—á–∞—è:
- –ë—Ä–µ–Ω–¥—ã
- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏  
- **–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–ø–æ–ª, —Å–µ–∑–æ–Ω –∏ –¥—Ä—É–≥–∏–µ)**
- –†–∞–∑–º–µ—Ä—ã
- –¶–≤–µ—Ç–∞

‚úÖ **–£–º–Ω–æ–µ —Å—É–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ** ‚Äî –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∏–ª—å—Ç—Ä–∞ —Å—á–µ—Ç—á–∏–∫–∏ –¥—Ä—É–≥–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Å —É—á–µ—Ç–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤.

‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (–º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –≤ production).

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –®–∞–≥–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞—Ç–∞–ª–æ–≥–∞ `/catalog`
2. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
3. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä "–ü–æ–ª" (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ú—É–∂—Å–∫–æ–π")
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ –ª–æ–≥: `üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: –ü–æ–ª (char_X)`
5. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—á–µ—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
6. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã (–±—Ä–µ–Ω–¥ + –ø–æ–ª + —Ü–µ–Ω–∞)
7. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å—á–µ—Ç—á–∏–∫–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –°—á–µ—Ç—á–∏–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤
- –ü—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∏–ª—å—Ç—Ä–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –æ–ø—Ü–∏–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è disabled
- –¢–æ–≤–∞—Ä—ã —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

1. `/controllers/CatalogController.php` ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ `getFiltersData()`
2. `/services/Catalog/FilterBuilder.php` ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–¥—Å—á–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ —á–µ—Ä–µ–∑ –ø–æ–¥–∑–∞–ø—Ä–æ—Å
3. `/web/js/catalog.js` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ –¥–ª—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è production:

1. **–û—Ç–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤ `catalog.js`:
   ```javascript
   // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ —Å console.log()
   ```

2. **–î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤ –≤ `FilterBuilder` (—É–∂–µ –µ—Å—Ç—å, –Ω–æ –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å TTL)

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Ç–æ–≤–∞—Ä–æ–≤

4. **–ò–Ω–¥–µ–∫—Å—ã –ë–î** ‚Äî —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –µ—Å—Ç—å –∏–Ω–¥–µ–∫—Å—ã –Ω–∞:
   - `product_characteristic_value.product_id`
   - `product_characteristic_value.characteristic_id`
   - `product_characteristic_value.characteristic_value_id`

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
2. –õ–æ–≥–∏ Yii2 –≤ `runtime/logs/app.log`
3. SQL –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ Yii2 Debug Panel

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
