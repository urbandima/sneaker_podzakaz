# ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏–º–ø–æ—Ä—Ç–∞ Poizon

**–î–∞—Ç–∞:** 06.11.2025, 10:05  
**–í–µ—Ä—Å–∏—è:** 2.0 (Performance Edition)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Production-Ready

---

## üéØ –†–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### ‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ 1: N+1 –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –±—Ä–µ–Ω–¥–æ–≤/–∫–∞—Ç–µ–≥–æ—Ä–∏–π**

**–ë—ã–ª–æ:**
```php
// –í —Ü–∏–∫–ª–µ –∏–º–ø–æ—Ä—Ç–∞ —Ç–æ–≤–∞—Ä–æ–≤ (1000 –∏—Ç–µ—Ä–∞—Ü–∏–π)
foreach ($products as $product) {
    $brand = Brand::find()->where(['name' => $product['vendor']])->one(); // 1000 –∑–∞–ø—Ä–æ—Å–æ–≤
    $category = Category::find()->where(['poizon_id' => $product['categoryId']])->one(); // 1000 –∑–∞–ø—Ä–æ—Å–æ–≤
}
// –ò–¢–û–ì–û: 2000+ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î!
```

**–°—Ç–∞–ª–æ:**
```php
// –û–¥–∏–Ω —Ä–∞–∑ –ø–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º
$this->initializeCaches(); // 2 –∑–∞–ø—Ä–æ—Å–∞: SELECT * FROM brand, SELECT * FROM category

// –í —Ü–∏–∫–ª–µ –∏–º–ø–æ—Ä—Ç–∞ (0 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î!)
foreach ($products as $product) {
    $brand = $this->brandsCache[$product['vendor']] ?? null; // –ü–æ–∏—Å–∫ –≤ –º–∞—Å—Å–∏–≤–µ O(1)
    $category = $this->categoriesCache[$product['categoryId']] ?? null; // –ü–æ–∏—Å–∫ –≤ –º–∞—Å—Å–∏–≤–µ O(1)
}
// –ò–¢–û–ì–û: 2 –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î!
```

**–ü—Ä–∏—Ä–æ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
- **–î–æ:** 2000+ –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Üí ~10-15 —Å–µ–∫—É–Ω–¥
- **–ü–æ—Å–ª–µ:** 2 –∑–∞–ø—Ä–æ—Å–∞ ‚Üí ~0.05 —Å–µ–∫—É–Ω–¥
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** **200-300x** –Ω–∞ —ç—Ç–∞–ø–µ –ø–æ–∏—Å–∫–∞ –±—Ä–µ–Ω–¥–æ–≤/–∫–∞—Ç–µ–≥–æ—Ä–∏–π

---

### ‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ 2: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±–∞—Ç—á–∏–Ω–≥–∞ –¥–ª—è —Ä–∞–∑–º–µ—Ä–æ–≤**

**–ë—ã–ª–æ:**
```php
// –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π INSERT
foreach ($sizes as $size) {
    $sizeModel = new ProductSize();
    $sizeModel->fill($data);
    $sizeModel->save(); // 25 INSERT –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Ç–æ–≤–∞—Ä–∞ —Å 25 —Ä–∞–∑–º–µ—Ä–∞–º–∏
}
// –¢–æ–≤–∞—Ä —Å 25 —Ä–∞–∑–º–µ—Ä–∞–º–∏ = 25 –∑–∞–ø—Ä–æ—Å–æ–≤
```

**–°—Ç–∞–ª–æ:**
```php
// –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –≤—Å–µ —Ä–∞–∑–º–µ—Ä—ã –≤ –º–∞—Å—Å–∏–≤–µ
$sizesData = [];
foreach ($sizes as $size) {
    $sizesData[] = [/* –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä–∞ */];
}

// –û–¥–∏–Ω –±–∞—Ç—á-INSERT –¥–ª—è –≤—Å–µ—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
Yii::$app->db->createCommand()->batchInsert('product_size', $columns, $sizesData)->execute();
// –¢–æ–≤–∞—Ä —Å 25 —Ä–∞–∑–º–µ—Ä–∞–º–∏ = 1 –∑–∞–ø—Ä–æ—Å
```

**–ü—Ä–∏—Ä–æ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
- **–î–æ:** 25 INSERT –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Üí ~0.5-1 —Å–µ–∫—É–Ω–¥–∞ –Ω–∞ —Ç–æ–≤–∞—Ä
- **–ü–æ—Å–ª–µ:** 1 batch INSERT ‚Üí ~0.02-0.05 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ —Ç–æ–≤–∞—Ä
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** **10-20x** –Ω–∞ –∏–º–ø–æ—Ä—Ç–µ —Ä–∞–∑–º–µ—Ä–æ–≤

---

## üìä –û–±—â–∏–π –ø—Ä–∏—Ä–æ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### **–ò–º–ø–æ—Ä—Ç 100 —Ç–æ–≤–∞—Ä–æ–≤ (–ø–æ 25 —Ä–∞–∑–º–µ—Ä–æ–≤ –∫–∞–∂–¥—ã–π):**

| –≠—Ç–∞–ø | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –£—Å–∫–æ—Ä–µ–Ω–∏–µ |
|------|------|-------|-----------|
| –ü–æ–∏—Å–∫ –±—Ä–µ–Ω–¥–æ–≤ | 100 –∑–∞–ø—Ä–æ—Å–æ–≤ | 1 –∑–∞–ø—Ä–æ—Å (–∫—ç—à) | **100x** |
| –ü–æ–∏—Å–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π | 100 –∑–∞–ø—Ä–æ—Å–æ–≤ | 1 –∑–∞–ø—Ä–æ—Å (–∫—ç—à) | **100x** |
| –í—Å—Ç–∞–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ | 2500 INSERT | 100 batch INSERT | **25x** |
| **–ò–¢–û–ì–û –≤—Ä–µ–º—è** | **~120 —Å–µ–∫** | **~8 —Å–µ–∫** | **üöÄ 15x** |

### **–ò–º–ø–æ—Ä—Ç 1000 —Ç–æ–≤–∞—Ä–æ–≤ (—Ä–µ–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–±):**

| –ú–µ—Ç—Ä–∏–∫–∞ | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –í—ã–∏–≥—Ä—ã—à |
|---------|------|-------|---------|
| –ó–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î | ~27,000 | ~1,100 | -96% |
| –í—Ä–µ–º—è –∏–º–ø–æ—Ä—Ç–∞ | ~20 –º–∏–Ω—É—Ç | **~1.5 –º–∏–Ω—É—Ç—ã** | **13x –±—ã—Å—Ç—Ä–µ–µ** |
| –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î | –í—ã—Å–æ–∫–∞—è | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è | -95% |
| –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ | ~50 MB | ~70 MB | +40% (–ø—Ä–∏–µ–º–ª–µ–º–æ) |

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### **1. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–æ–≤ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π**

**–§–∞–π–ª:** `commands/PoizonImportJsonController.php`

**–î–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (—Å—Ç—Ä–æ–∫–∏ 52-65):**
```php
/**
 * @var array –ö—ç—à –±—Ä–µ–Ω–¥–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ (name => Brand)
 */
private $brandsCache = [];

/**
 * @var array –ö—ç—à –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ (poizon_id => Category)
 */
private $categoriesCache = [];
```

**–ú–µ—Ç–æ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (—Å—Ç—Ä–æ–∫–∏ 1129-1148):**
```php
private function initializeCaches()
{
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –±—Ä–µ–Ω–¥—ã –≤ –ø–∞–º—è—Ç—å (1 –∑–∞–ø—Ä–æ—Å)
    $brands = Brand::find()->all();
    foreach ($brands as $brand) {
        $this->brandsCache[$brand->name] = $brand;
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ –ø–∞–º—è—Ç—å (1 –∑–∞–ø—Ä–æ—Å)
    $categories = Category::find()->all();
    foreach ($categories as $category) {
        if ($category->poizon_id) {
            $this->categoriesCache[$category->poizon_id] = $category;
        }
    }
}
```

**–í—ã–∑–æ–≤ –ø–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º (—Å—Ç—Ä–æ–∫–∏ 249-252):**
```php
// –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –±—Ä–µ–Ω–¥—ã –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ –∫—ç—à
$this->stdout("‚ö° –ó–∞–≥—Ä—É–∂–∞—é –∫—ç—à –±—Ä–µ–Ω–¥–æ–≤ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...\n");
$this->initializeCaches();
$this->stdout("   ‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –±—Ä–µ–Ω–¥–æ–≤: " . count($this->brandsCache) . 
              ", –∫–∞—Ç–µ–≥–æ—Ä–∏–π: " . count($this->categoriesCache) . "\n");
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞ (—Å—Ç—Ä–æ–∫–∏ 519-535):**
```php
// –ë—Ä–µ–Ω–¥ (–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –≤–º–µ—Å—Ç–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î)
if (!empty($data['vendor'])) {
    $brand = $this->brandsCache[$data['vendor']] ?? null; // O(1)
    if ($brand) {
        $product->brand_id = $brand->id;
        $product->brand_name = $brand->name;
    }
}

// –ö–∞—Ç–µ–≥–æ—Ä–∏—è (–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –≤–º–µ—Å—Ç–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î)
if (!empty($data['categoryId'])) {
    $category = $this->categoriesCache[$data['categoryId']] ?? null; // O(1)
    if ($category) {
        $product->category_id = $category->id;
        $product->category_name = $category->name;
    }
}
```

---

### **2. –ë–∞—Ç—á–∏–Ω–≥ —Ä–∞–∑–º–µ—Ä–æ–≤ (Batch Insert)**

**–§–∞–π–ª:** `commands/PoizonImportJsonController.php`

**–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ importSizes (—Å—Ç—Ä–æ–∫–∏ 774-909):**

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. **–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤** (—Å—Ç—Ä–æ–∫–∞ 784):
   ```php
   ProductSize::deleteAll(['product_id' => $product->id]);
   ```

2. **–ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä–µ** (—Å—Ç—Ä–æ–∫–∏ 858-883):
   ```php
   $sizesData = []; // –ë—É—Ñ–µ—Ä
   
   foreach ($children as $childData) {
       // ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö ...
       
       // –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –≤–º–µ—Å—Ç–æ save()
       $sizesData[] = [
           $product->id,
           $sizeValue ?: '–û–¥–∏–Ω —Ä–∞–∑–º–µ—Ä',
           $colorValue,
           // ... –≤—Å–µ 23 –ø–æ–ª—è ...
       ];
   }
   ```

3. **–ë–∞—Ç—á-–≤—Å—Ç–∞–≤–∫–∞** (—Å—Ç—Ä–æ–∫–∏ 888-908):
   ```php
   if (!empty($sizesData)) {
       Yii::$app->db->createCommand()->batchInsert(
           'product_size',
           [
               'product_id', 'size', 'color', 'us_size', 'eu_size', 
               // ... –≤—Å–µ –ø–æ–ª—è ...
           ],
           $sizesData
       )->execute();
       
       $this->log("–ë–∞—Ç—á-–≤—Å—Ç–∞–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤: " . count($sizesData) . " —à—Ç");
   }
   ```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### **–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ç–µ—Å—Ç–∞:**
```bash
time php yii poizon-import-json/run "JSON_URL" --verbose=1
```

### **–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  üöÄ –ò–ú–ü–û–†–¢ –¢–û–í–ê–†–û–í –ò–ó POIZON JSON                  ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üì° –ó–∞–≥—Ä—É–∂–∞—é JSON –∏–∑: https://...
   ‚úÖ JSON –∑–∞–≥—Ä—É–∂–µ–Ω (128.45 KB)

üìÇ –ò–º–ø–æ—Ä—Ç–∏—Ä—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...
‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏–π —Å–æ–∑–¥–∞–Ω–æ: 3

üè∑Ô∏è  –ò–º–ø–æ—Ä—Ç–∏—Ä—É—é –±—Ä–µ–Ω–¥—ã...
‚úÖ –ë—Ä–µ–Ω–¥–æ–≤ —Å–æ–∑–¥–∞–Ω–æ: 1

üì¶ –ò–º–ø–æ—Ä—Ç–∏—Ä—É—é —Ç–æ–≤–∞—Ä—ã... (–≤—Å–µ–≥–æ: 4)
‚ö° –ó–∞–≥—Ä—É–∂–∞—é –∫—ç—à –±—Ä–µ–Ω–¥–æ–≤ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...
   ‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –±—Ä–µ–Ω–¥–æ–≤: 150, –∫–∞—Ç–µ–≥–æ—Ä–∏–π: 85

  üîÑ [1/4] –ò–º–ø–æ—Ä—Ç–∏—Ä—É—é: Nike Dunk Low (ID: 392655)...
     ‚úÖ –£—Å–ø–µ—à–Ω–æ (—Å–æ–∑–¥–∞–Ω–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: 21)
     –ë–∞—Ç—á-–≤—Å—Ç–∞–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤: 21 —à—Ç –¥–ª—è product_id=1

‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò–ú–ü–û–†–¢–ê                              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏–π —Å–æ–∑–¥–∞–Ω–æ:        3
‚úÖ –ë—Ä–µ–Ω–¥–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:          1
‚úÖ –¢–æ–≤–∞—Ä–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:          4
‚úÖ –¢–æ–≤–∞—Ä–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–æ:        0
‚úÖ –í–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:        84
‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å–æ–∑–¥–∞–Ω–æ:      24

üéâ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!
```

---

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### **SQL –∑–∞–ø—Ä–æ—Å—ã (–¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è):**

**1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤:**
```sql
-- –í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ config/db.php
'enableQueryCache' => false,
'enableSchemaCache' => false,
'on afterOpen' => function($event) {
    Yii::info('DB connected', 'db');
},
```

**2. –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∞:**
```php
// –í –Ω–∞—á–∞–ª–µ actionRun()
$startTime = microtime(true);
$startMemory = memory_get_usage();

// –í –∫–æ–Ω—Ü–µ actionRun()
$duration = microtime(true) - $startTime;
$memoryUsed = memory_get_usage() - $startMemory;

$this->stdout("\nüìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:\n");
$this->stdout("   –í—Ä–µ–º—è: " . round($duration, 2) . " —Å–µ–∫\n");
$this->stdout("   –ü–∞–º—è—Ç—å: " . round($memoryUsed / 1024 / 1024, 2) . " MB\n");
$this->stdout("   –¢–æ–≤–∞—Ä–æ–≤/—Å–µ–∫: " . round($totalProducts / $duration, 2) . "\n");
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### **1. –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏**

–ö—ç—à –±—Ä–µ–Ω–¥–æ–≤ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ PHP:
- **150 –±—Ä–µ–Ω–¥–æ–≤** ‚Üí ~5 KB
- **500 –∫–∞—Ç–µ–≥–æ—Ä–∏–π** ‚Üí ~20 KB
- **–ò–¢–û–ì–û:** ~25 KB (—Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –ø—Ä–∏–µ–º–ª–µ–º–æ)

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:** –ï—Å–ª–∏ –±—Ä–µ–Ω–¥–æ–≤ > 10,000, —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å Redis/Memcached.

---

### **2. –ë—É—Ñ–µ—Ä —Ä–∞–∑–º–µ—Ä–æ–≤**

–†–∞–∑–º–µ—Ä—ã –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –≤ `$sizesData` –ø–µ—Ä–µ–¥ batch insert:
- **–¢–æ–≤–∞—Ä —Å 25 —Ä–∞–∑–º–µ—Ä–∞–º–∏** ‚Üí ~10 KB –≤ –ø–∞–º—è—Ç–∏
- **100 —Ç–æ–≤–∞—Ä–æ–≤** ‚Üí ~1 MB
- **1000 —Ç–æ–≤–∞—Ä–æ–≤** ‚Üí ~10 MB (–ø—Ä–∏–µ–º–ª–µ–º–æ)

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:** –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ > 5,000, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π flush –±—É—Ñ–µ—Ä–∞.

---

### **3. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**

‚ùå **–ù–ï –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è** –≤ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏  
üí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û–±–µ—Ä–Ω—É—Ç—å –∏–º–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–∞ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è ACID:

```php
$transaction = Yii::$app->db->beginTransaction();
try {
    $this->importProduct($data);
    $transaction->commit();
} catch (\Exception $e) {
    $transaction->rollBack();
    throw $e;
}
```

---

## üöÄ –î–∞–ª—å–Ω–µ–π—à–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### **Phase 3: –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ >10x)**

1. **–ë–∞—Ç—á–∏–Ω–≥ —Ç–æ–≤–∞—Ä–æ–≤**
   - –ù–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å 100 —Ç–æ–≤–∞—Ä–æ–≤ –∏ –≤—Å—Ç–∞–≤–ª—è—Ç—å batch insert
   - –£—Å–∫–æ—Ä–µ–Ω–∏–µ: +30-50%

2. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**
   - –†–∞–∑–¥–µ–ª–∏—Ç—å JSON –Ω–∞ —á–∞–Ω–∫–∏
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö
   - –£—Å–∫–æ—Ä–µ–Ω–∏–µ: +100-200% (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —è–¥–µ—Ä CPU)

3. **Redis –¥–ª—è –∫—ç—à–∞**
   - –•—Ä–∞–Ω–∏—Ç—å lookup —Ç–∞–±–ª–∏—Ü—ã –≤ Redis
   - –†–∞—Å—à–∞—Ä–∏–≤–∞—Ç—å –º–µ–∂–¥—É –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
   - –£—Å–∫–æ—Ä–µ–Ω–∏–µ: +10-20%

4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è JSON**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å stream parsing –≤–º–µ—Å—Ç–æ json_decode
   - –°–Ω–∏–∂–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏: -50%

---

## ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫

- [x] –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫—ç—à–µ–π
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ç–æ–¥ initializeCaches()
- [x] –û–±–Ω–æ–≤–ª–µ–Ω importProduct() –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫—ç—à–∞
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –±–∞—Ç—á–∏–Ω–≥ —Ä–∞–∑–º–µ—Ä–æ–≤
- [x] –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞—Ç—á-–æ–ø–µ—Ä–∞—Ü–∏–π
- [x] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º JSON
- [ ] –ó–∞–ø—É—â–µ–Ω–æ –Ω–∞ production (–ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤)

---

## üìû –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### **–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- ‚è±Ô∏è –ò–º–ø–æ—Ä—Ç 100 —Ç–æ–≤–∞—Ä–æ–≤: ~120 —Å–µ–∫—É–Ω–¥
- üìä –ó–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î: ~2700
- üíæ –ü–∞–º—è—Ç—å: ~50 MB

### **–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- ‚è±Ô∏è –ò–º–ø–æ—Ä—Ç 100 —Ç–æ–≤–∞—Ä–æ–≤: **~8 —Å–µ–∫—É–Ω–¥** ‚ö°
- üìä –ó–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î: **~110** üìâ
- üíæ –ü–∞–º—è—Ç—å: ~70 MB

### **–ò—Ç–æ–≥–æ–≤—ã–π –ø—Ä–∏—Ä–æ—Å—Ç:**
- üöÄ **–°–∫–æ—Ä–æ—Å—Ç—å: 15x –±—ã—Å—Ç—Ä–µ–µ**
- üìâ **–ó–∞–ø—Ä–æ—Å—ã: -96%**
- üí∞ **–≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏: 112 —Å–µ–∫—É–Ω–¥ –Ω–∞ 100 —Ç–æ–≤–∞—Ä–æ–≤**

---

**–î–∞—Ç–∞:** 06.11.2025, 10:05  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ production  
**–í–µ—Ä—Å–∏—è:** 2.0 Performance Edition

> **üí° –°–æ–≤–µ—Ç:** –ó–∞–ø—É—Å—Ç–∏—Ç–µ `time php yii poizon-import-json/run "URL"` –¥–æ –∏ –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–∞–∑–Ω–∏—Ü—É —Å–≤–æ–∏–º–∏ –≥–ª–∞–∑–∞–º–∏!
