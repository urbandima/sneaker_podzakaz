# Финальный аудит сайта (YII2)

## 1. Архитектура и структура
- **[Модульность]** Доменные границы размыты: бизнес-логика распределена между `controllers/`, `models/` и `components/`. `CatalogController` перегружен фильтрами, кешем и SEO. Требуется слой сервисов + DTO и единые фасады для каталога, заказов, интеграций.
- **[Контуры данных]** `models/Product.php` и `repositories/ProductRepository.php` используют ActiveRecord напрямую; отсутствует уровень репозиториев для всех сущностей и политика unit-of-work. Рекомендуется выделить `domain/` с аггрегатами и query-объектами.
- **[Инфраструктура]** `config/web.php` содержит смешанные правила (публичные и админские). Нужен разнос по модулям (`modules/admin`, `modules/api`) и единый bootstrap. Миграции в `migrations/` раздроблены, без ревизий и документации по откатам.
- **[Документация]** Есть множество исторических отчётов (`CONTAINER_FIX_SUMMARY.md`, `CSS_DEDUPLICATION_REPORT.md`), но отсутствуют актуальные ADR, диаграммы контуров, спецификация API. Требуется единая структура `docs/architecture/`.

## 2. Чистота, валидность, повторяемость кода
- **[Дубли]** Фильтрация каталога реализована параллельно в `services/Catalog/FilterBuilder.php` и `web/js/catalog.js`, что ведёт к несинхронным условиям. Необходимо вынести правило построения фильтров в конфигурационные объекты и автогенерировать фронтовые пресеты.
- **[Мёртвый код]** Скрипты в корне (`check-*.sh`, `test_*.php`) и архивные документы дублируют функциональность из `docs/archive/`. Требуется каталог `maintenance/` с актуальными утилитами и удаление неиспользуемых.
- **[Assets]** `assets/AppAsset.php` подключает стили, часть из которых не referenced в `views/`. Нет pipeline для PurgeCSS/critical CSS. В `web/css/` присутствуют устаревшие файлы (`catalog-inline.css`, `cart-mobile.css`).
- **[Стандарты]** Отсутствуют линтеры и статический анализ (`phpcs`, `phpstan`). Стиль PHP колеблется между PSR-2/12. Не настроены pre-commit хуки.

## 3. Функциональные баги и ошибки
- **[Формы/заявки]** `models/CatalogInquiry.php` полагается на фронтовую валидацию; нет защиты от повторной отправки и лимитов. Ошибка обработки email приводит к silent fail. Нужны form objects + rate limiting.
- **[Фильтры]** `CatalogController::actionFilter()` и `FilterBuilder` используют динамический SQL с конкатенацией (`Product::find()->where([...])`), что допускает неконтролируемые параметры из GET. Требуется whitelisting и DTO для параметров.
- **[Авторизация]** API-контроллеры (`controllers/api/CharacteristicController.php`) допускают CORS `Origin=*` с `Access-Control-Allow-Credentials=true`, что опасно без origin whitelist. Часть админ-роутов не защищена middleware на уровне `urlManager`.
- **[Интеграции]** Почтовые уведомления (`mail/catalog-inquiry-manager.php`) не имеют retry/queue. Курсы валют (`components/CurrencyService.php`) fallback'ят silently; нет мониторинга ошибок.

## 4. Дизайн, скорость, адаптивность
- **[Mobile-first]** CSS разделён на пачки десктоп/мобайл; нет единой дизайн-системы. Компоненты карточек (`web/css/catalog-card.css`) не используют CSS custom properties. Нужно перейти на SCSS + tokens.
- **[Лоадинг]** `web/js/catalog.js` выполняет тяжёлую инициализацию при `DOMContentLoaded`, без code-splitting. Нет lazy-hydration для невидимых модулей.
- **[UX]** Отсутствуют skeleton states для списка товаров (кроме статичного `#skeletonGrid`), не отображается состояний пустых данных. Модальное окно быстрых заявок не валидирует телефон.
- **[Accessibility]** Нет aria-атрибутов в навигации, focus-styles отключены. Требуется аудит Lighthouse/axe.

## 5. Безопасность и производительность
- **[SQL/XSS]** `ProductRepository` и `FilterBuilder` строят запросы с непосредственной передачей массивов, но часть фильтров (характеристики) подставляется вручную. Не хватает `QueryParam`, escaping и серверной нормализации. В `views/catalog/product.php` встречаются прямые `<?= $model->... ?>` без `Html::encode`.
- **[CSRF/Sessions]** Глобальная опция `enableCsrfValidation` не указана явно. В API отсутствует rotate refresh-token и revoke flow. Админ-logout без double-submit protection.
- **[Кэш/перф]** `CacheManager` централизует операции, но нет мониторинга hit/miss. Кэш TTL статичен. MySQL индексы (`migrations/*`) не покрывают фильтры по характеристикам/цветам. Нужны профилировка (`EXPLAIN`, `slow_query_log`), Redis cluster.
- **[Observability]** Нет централизованных логов, алертов. Ошибки от внешних API логируются только в файлы.

## 6. Итоговая оценка (из 100)
- Архитектура — 55
- Чистота кода — 50
- Функциональность — 60
- UX/UI — 58
- Безопасность/перфоманс — 48
- **Общая оценка:** 54/100

## 7. Project Tasks
- **[P0 · 5 дн]** Ввести слой сервисов/DTO для каталога и заказов, разгрузить `CatalogController`, оформить ADR модулей.
- **[P0 · 4 дн]** Переписать фильтры (бэкенд+фронт): whitelisting, prepared statements, покрытие unit-тестами, синхронизация конфигов.
- **[P0 · 3 дн]** Усилить формы и заявки: серверная валидация, rate limiting, очередь email, e2e тесты заявки → заказ.
- **[P1 · 3 дн]** CI/CD pipeline с `phpcs`, `phpstan`, `eslint`, `stylelint`, тестами и quality gate.
- **[P1 · 4 дн]** Рефакторинг фронта каталога: модульная сборка (Vite), code-splitting, skeleton, Lighthouse ≥ 90.
- **[P1 · 2 дн]** Безопасность: CSP, origin whitelist, CSRF аудит, refresh-token flow, секреты в Vault.
- **[P2 · 2 дн]** Очистка assets: PurgeCSS, критический CSS, единая дизайн-система, tokens.
- **[P2 · 3 дн]** UX и accessibility: aria, focus, mobile-first сетка, empty/error states.
- **[P2 · 2 дн]** Observability + caching: метрики hit/miss, Redis мониторинг, slow-query аудит.
- **[P3 · 2 дн]** Консолидация миграций, стратегия откатов, документация деплоя.

## 8. Итоговое summary — дорога к совершенству
- **[Старт]** Текущий монолит опирается на ActiveRecord и множественные хардкод-решения, что усложняет масштабирование и снижает надёжность.
- **[Шаги]** 1) Защитить проект (валидация, безопасность, перф). 2) Навести архитектурный порядок (сервисы, ADR, модульность). 3) Освежить фронтенд и UX, внедрить автоматизацию качества.
- **[Финиш]** Модульный YII2 с чёткой документацией, мониторингом, современной сборкой и устойчивой архитектурой, готовый к росту и интеграциям.
