<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="test-token">
    <title>–¢–µ—Å—Ç –∫–æ—Ä–∑–∏–Ω—ã –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
        }
        h2 {
            color: #666;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .test-item {
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
            border-left: 4px solid #4CAF50;
            border-radius: 4px;
        }
        .test-item.failed {
            border-left-color: #f44336;
        }
        .test-item.pending {
            border-left-color: #ff9800;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        button.secondary {
            background: #2196F3;
        }
        button.secondary:hover {
            background: #0b7dda;
        }
        .result {
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .result.success {
            background: #d4edda;
            color: #155724;
        }
        .result.error {
            background: #f8d7da;
            color: #721c24;
        }
        .checklist {
            list-style: none;
            padding: 0;
        }
        .checklist li {
            padding: 8px;
            margin: 5px 0;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .checklist li:before {
            content: '‚òê ';
            color: #999;
            font-weight: bold;
            margin-right: 10px;
        }
        .checklist li.done:before {
            content: '‚úì ';
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ</h1>

    <!-- –¢–ï–°–¢ 1: –ö–æ—Ä–∑–∏–Ω–∞ -->
    <div class="test-section">
        <h2>üõí –¢–µ—Å—Ç 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É</h2>
        <div class="test-item">
            <strong>–¢–µ—Å—Ç A: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É</strong>
            <button onclick="testAddToCart()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
            <div id="result-add-cart"></div>
        </div>
        <div class="test-item">
            <strong>–¢–µ—Å—Ç B: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞</strong>
            <button onclick="testUpdateCart()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
            <div id="result-update-cart"></div>
        </div>
        <div class="test-item">
            <strong>–¢–µ—Å—Ç C: –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã</strong>
            <button onclick="testRemoveFromCart()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
            <div id="result-remove-cart"></div>
        </div>
        <div class="test-item">
            <strong>–¢–µ—Å—Ç D: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã</strong>
            <button onclick="testCartCount()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
            <div id="result-cart-count"></div>
        </div>
    </div>

    <!-- –¢–ï–°–¢ 2: –ò–∑–±—Ä–∞–Ω–Ω–æ–µ -->
    <div class="test-section">
        <h2>‚ù§Ô∏è –¢–µ—Å—Ç 2: –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h2>
        <div class="test-item">
            <strong>–¢–µ—Å—Ç A: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</strong>
            <button onclick="testAddFavorite()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
            <div id="result-add-favorite"></div>
        </div>
        <div class="test-item">
            <strong>–¢–µ—Å—Ç B: –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ</strong>
            <button onclick="testRemoveFavorite()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
            <div id="result-remove-favorite"></div>
        </div>
        <div class="test-item">
            <strong>–¢–µ—Å—Ç C: Toggle –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ</strong>
            <button onclick="testToggleFavorite()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
            <div id="result-toggle-favorite"></div>
        </div>
        <div class="test-item">
            <strong>–¢–µ—Å—Ç D: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ</strong>
            <button onclick="testFavoriteCount()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
            <div id="result-favorite-count"></div>
        </div>
    </div>

    <!-- –¢–ï–°–¢ 3: CSRF Protection -->
    <div class="test-section">
        <h2>üîí –¢–µ—Å—Ç 3: CSRF Protection</h2>
        <div class="test-item">
            <strong>–¢–µ—Å—Ç A: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è CSRF meta-—Ç–µ–≥–∞</strong>
            <button onclick="testCsrfMetaTag()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
            <div id="result-csrf-meta"></div>
        </div>
        <div class="test-item">
            <strong>–¢–µ—Å—Ç B: CSRF —Ç–æ–∫–µ–Ω –≤ –∑–∞–ø—Ä–æ—Å–µ</strong>
            <button onclick="testCsrfInRequest()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
            <div id="result-csrf-request"></div>
        </div>
    </div>

    <!-- –ß–ï–ö–õ–ò–°–¢ –†–£–ß–ù–û–ì–û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø -->
    <div class="test-section">
        <h2>üìã –†—É—á–Ω–æ–π —á–µ–∫–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        <ul class="checklist">
            <li>–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞—Ç–∞–ª–æ–≥–∞ /catalog</li>
            <li>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ (–∫–ª–∏–∫ –Ω–∞ —Å–µ—Ä–¥–µ—á–∫–æ)</li>
            <li>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –≤ header</li>
            <li>–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç–æ–≤–∞—Ä–∞ /catalog/product/[slug]</li>
            <li>–í—ã–±—Ä–∞—Ç—å —Ä–∞–∑–º–µ—Ä –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä–µ —Ä–∞–∑–º–µ—Ä–æ–≤</li>
            <li>–ù–∞–∂–∞—Ç—å "–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É"</li>
            <li>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—è–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ</li>
            <li>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã –≤ header</li>
            <li>–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–æ—Ä–∑–∏–Ω—ã /cart</li>
            <li>–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞</li>
            <li>–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã</li>
            <li>–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ /catalog/favorites</li>
            <li>–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ</li>
            <li>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞</li>
        </ul>
    </div>

    <script>
        const API_BASE = window.location.origin;

        // –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞
        function getCsrfToken() {
            const meta = document.querySelector('meta[name="csrf-token"]');
            return meta ? meta.getAttribute('content') : '';
        }

        // –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        function showResult(elementId, success, message, data = null) {
            const element = document.getElementById(elementId);
            const className = success ? 'success' : 'error';
            let html = `<div class="result ${className}">
                <strong>${success ? '‚úì –£–°–ü–ï–•' : '‚úó –û–®–ò–ë–ö–ê'}:</strong> ${message}`;
            if (data) {
                html += `<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            html += '</div>';
            element.innerHTML = html;
        }

        // ===== –¢–ï–°–¢–´ –ö–û–†–ó–ò–ù–´ =====

        async function testAddToCart() {
            try {
                const response = await fetch(`${API_BASE}/cart/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': getCsrfToken()
                    },
                    body: JSON.stringify({
                        product_id: 1,
                        size: '42',
                        quantity: 1
                    })
                });
                const data = await response.json();
                showResult('result-add-cart', data.success, 
                    data.success ? '–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É' : data.message, data);
            } catch (error) {
                showResult('result-add-cart', false, error.message);
            }
        }

        async function testUpdateCart() {
            try {
                const response = await fetch(`${API_BASE}/cart/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': getCsrfToken()
                    },
                    body: JSON.stringify({
                        id: 1,
                        quantity: 2
                    })
                });
                const data = await response.json();
                showResult('result-update-cart', data.success, 
                    data.success ? '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ' : data.message, data);
            } catch (error) {
                showResult('result-update-cart', false, error.message);
            }
        }

        async function testRemoveFromCart() {
            try {
                const response = await fetch(`${API_BASE}/cart/remove/1`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': getCsrfToken()
                    }
                });
                const data = await response.json();
                showResult('result-remove-cart', data.success, 
                    data.success ? '–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω' : data.message, data);
            } catch (error) {
                showResult('result-remove-cart', false, error.message);
            }
        }

        async function testCartCount() {
            try {
                const response = await fetch(`${API_BASE}/cart/count`);
                const data = await response.json();
                showResult('result-cart-count', true, 
                    `–¢–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ: ${data.count}`, data);
            } catch (error) {
                showResult('result-cart-count', false, error.message);
            }
        }

        // ===== –¢–ï–°–¢–´ –ò–ó–ë–†–ê–ù–ù–û–ì–û =====

        async function testAddFavorite() {
            try {
                const response = await fetch(`${API_BASE}/catalog/add-favorite`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': getCsrfToken()
                    },
                    body: JSON.stringify({
                        product_id: 1
                    })
                });
                const data = await response.json();
                showResult('result-add-favorite', data.success, 
                    data.success ? '–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' : data.message, data);
            } catch (error) {
                showResult('result-add-favorite', false, error.message);
            }
        }

        async function testRemoveFavorite() {
            try {
                const response = await fetch(`${API_BASE}/catalog/remove-favorite`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': getCsrfToken()
                    },
                    body: JSON.stringify({
                        product_id: 1
                    })
                });
                const data = await response.json();
                showResult('result-remove-favorite', data.success, 
                    data.success ? '–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : data.message, data);
            } catch (error) {
                showResult('result-remove-favorite', false, error.message);
            }
        }

        async function testToggleFavorite() {
            try {
                const response = await fetch(`${API_BASE}/favorite/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': getCsrfToken()
                    },
                    body: JSON.stringify({
                        product_id: 1
                    })
                });
                const data = await response.json();
                showResult('result-toggle-favorite', data.success, 
                    data.success ? `–î–µ–π—Å—Ç–≤–∏–µ: ${data.action}` : data.message, data);
            } catch (error) {
                showResult('result-toggle-favorite', false, error.message);
            }
        }

        async function testFavoriteCount() {
            try {
                const response = await fetch(`${API_BASE}/favorite/count`);
                const data = await response.json();
                showResult('result-favorite-count', true, 
                    `–¢–æ–≤–∞—Ä–æ–≤ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º: ${data.count}`, data);
            } catch (error) {
                showResult('result-favorite-count', false, error.message);
            }
        }

        // ===== –¢–ï–°–¢–´ CSRF =====

        function testCsrfMetaTag() {
            const meta = document.querySelector('meta[name="csrf-token"]');
            if (meta && meta.getAttribute('content')) {
                showResult('result-csrf-meta', true, 
                    'CSRF meta-—Ç–µ–≥ –Ω–∞–π–¥–µ–Ω', { token: meta.getAttribute('content') });
            } else {
                showResult('result-csrf-meta', false, 
                    'CSRF meta-—Ç–µ–≥ –ù–ï –Ω–∞–π–¥–µ–Ω! –î–æ–±–∞–≤—å—Ç–µ –≤ layout.');
            }
        }

        function testCsrfInRequest() {
            const token = getCsrfToken();
            if (token) {
                showResult('result-csrf-request', true, 
                    'CSRF —Ç–æ–∫–µ–Ω –±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ X-CSRF-Token', { token });
            } else {
                showResult('result-csrf-request', false, 
                    'CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
        }

        // –ó–∞–ø—É—Å–∫ –±–∞–∑–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            testCsrfMetaTag();
            testCsrfInRequest();
        });
    </script>
</body>
</html>
