# –ì–∏–±—Ä–∏–¥–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

**–î–∞—Ç–∞:** 2025-11-10  
**–í–µ—Ä—Å–∏—è:** 2.0

## –ü—Ä–æ–±–ª–µ–º–∞

–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ —Ç–∞–±–ª–∏—Ü—É `product_characteristic_value` –¥–ª—è –≤—Å–µ—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫, –Ω–æ –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏:
- –í `product_characteristic_value`: —Ç–æ–ª—å–∫–æ 20 —Ç–æ–≤–∞—Ä–æ–≤ (12 –º—É–∂—Å–∫–∏—Ö + 8 –∂–µ–Ω—Å–∫–∏—Ö)
- –í `product.gender`: 675 —Ç–æ–≤–∞—Ä–æ–≤ (–≤—Å–µ —É–Ω–∏—Å–µ–∫—Å)

–≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é —Å—á–µ—Ç—á–∏–∫–æ–≤ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.

## –†–µ—à–µ–Ω–∏–µ: –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö:

### –ü–æ–ª—è product (–≥–∏–±—Ä–∏–¥–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏)
–ò—Å–ø–æ–ª—å–∑—É—é—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `product`:
- ‚úÖ **gender** (–ü–æ–ª): `male`, `female`, `unisex`
- ‚úÖ **season** (–°–µ–∑–æ–Ω): `summer`, `winter`, `demi`, `all`
- ‚úÖ **material** (–ú–∞—Ç–µ—Ä–∏–∞–ª): `leather`, `textile`, `synthetic`, `suede`, `mesh`, `canvas`
- ‚úÖ **height** (–í—ã—Å–æ—Ç–∞): `low`, `mid`, `high`
- ‚úÖ **fastening** (–ó–∞—Å—Ç–µ–∂–∫–∞): `laces`, `velcro`, `zipper`, `slip_on`
- ‚úÖ **country** (–°—Ç—Ä–∞–Ω–∞): –ª—é–±–∞—è —Å—Ç—Ä–æ–∫–∞

### –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–∑ –ë–î
–ò—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–∞–±–ª–∏—Ü—É `product_characteristic_value`:
- –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. FilterBuilder::buildCharacteristicsFilters()

```php
// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –ø–æ–ª–µ product –∏–ª–∏ characteristic_value
$isProductField = in_array($characteristic['key'], [
    'gender', 'season', 'material', 'height', 'fastening', 'country'
]);

if ($isProductField) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ product –Ω–∞–ø—Ä—è–º—É—é
    $filterData = self::buildProductFieldFilter($characteristic, $currentFilters, $baseConditions);
} else {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º product_characteristic_value
    $filterData = self::buildStandardFilter($characteristic, ...);
}
```

### 2. FilterBuilder::buildProductFieldFilter()

–ù–æ–≤—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –∏–∑ –ø–æ–ª—è `product`:

```php
protected static function buildProductFieldFilter(array $characteristic, ...): array
{
    // –ó–∞–ø—Ä–æ—Å –∫ product —Å GROUP BY –ø–æ –ø–æ–ª—é
    $query = Product::find()
        ->select([$fieldName, 'COUNT(*) as count'])
        ->where(['is_active' => 1])
        ->andWhere(['IS NOT', $fieldName, null])
        ->groupBy([$fieldName]);
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è —É–º–Ω–æ–≥–æ —Å—É–∂–µ–Ω–∏—è
    self::applyFiltersToQuery($query, $currentFilters, $baseConditions, $excludeKeys);
    
    // –ú–∞–ø–ø–∏–Ω–≥ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
    $valueLabels = self::getProductFieldLabels($fieldName);
    
    return [
        'id' => $characteristic['id'],
        'key' => $characteristic['key'],
        'name' => $characteristic['name'],
        'values' => [...], // –ú–∞—Å—Å–∏–≤ —Å count –∏–∑ product
        'is_product_field' => true, // –§–ª–∞–≥ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
    ];
}
```

### 3. FilterBuilder::applyFiltersToQuery()

–û–±–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤:

```php
// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
$characteristic = Characteristic::findOne($charId);

if ($characteristic && in_array($characteristic->key, ['gender', 'season', ...])) {
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–æ–ª—é product –Ω–∞–ø—Ä—è–º—É—é
    $query->andWhere(['product.' . $characteristic->key => $value]);
} else {
    // –§–∏–ª—å—Ç—Ä—É–µ–º —á–µ—Ä–µ–∑ product_characteristic_value
    $query->andWhere(['product.id' => ProductCharacteristicValue::find()->...]);
}
```

### 4. View: _characteristic_filter.php

–û–±–Ω–æ–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π:

```php
// –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–ª—è –ø–æ–ª–µ–π product value['id'] - —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ ('unisex'), –∞ –Ω–µ —á–∏—Å–ª–æ
$valueId = $value['id'];
$isChecked = is_array($currentValues) && in_array($valueId, $currentValues);
```

## –ú–∞–ø–ø–∏–Ω–≥ –∑–Ω–∞—á–µ–Ω–∏–π

### getProductFieldLabels()

–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–µ:

```php
'gender' => [
    'male' => '–ú—É–∂—Å–∫–æ–π',
    'female' => '–ñ–µ–Ω—Å–∫–∏–π',
    'unisex' => '–£–Ω–∏—Å–µ–∫—Å',
],
'season' => [
    'summer' => '–õ–µ—Ç–æ',
    'winter' => '–ó–∏–º–∞',
    'demi' => '–î–µ–º–∏—Å–µ–∑–æ–Ω',
    'all' => '–í—Å–µ—Å–µ–∑–æ–Ω–Ω—ã–µ',
],
// ... –∏ —Ç.–¥.
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
–§–∏–ª—å—Ç—Ä "–ü–æ–ª":
- –ú—É–∂—Å–∫–æ–π: 12 —Ç–æ–≤–∞—Ä–æ–≤ (–∏–∑ product_characteristic_value)
- –ñ–µ–Ω—Å–∫–∏–π: 8 —Ç–æ–≤–∞—Ä–æ–≤ (–∏–∑ product_characteristic_value)
- –£–Ω–∏—Å–µ–∫—Å: 0 —Ç–æ–≤–∞—Ä–æ–≤
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
–§–∏–ª—å—Ç—Ä "–ü–æ–ª":
- –£–Ω–∏—Å–µ–∫—Å: 675 —Ç–æ–≤–∞—Ä–æ–≤ (–∏–∑ product.gender) ‚úÖ
```

### –î—Ä—É–≥–∏–µ –≥–∏–±—Ä–∏–¥–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:
```
- –°–µ–∑–æ–Ω: 186 —Ç–æ–≤–∞—Ä–æ–≤ ‚úÖ
- –ú–∞—Ç–µ—Ä–∏–∞–ª: 0 —Ç–æ–≤–∞—Ä–æ–≤ (–Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ)
- –í—ã—Å–æ—Ç–∞: 4 —Ç–æ–≤–∞—Ä–∞ ‚úÖ
- –ó–∞—Å—Ç–µ–∂–∫–∞: 4 —Ç–æ–≤–∞—Ä–∞ ‚úÖ
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç:
```bash
php test-hybrid-filter.php
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```
‚úÖ –§–∏–ª—å—Ç—Ä '–ü–æ–ª' –Ω–∞–π–¥–µ–Ω
–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö: product.gender (–≥–∏–±—Ä–∏–¥–Ω—ã–π)
–ó–Ω–∞—á–µ–Ω–∏—è:
   - –£–Ω–∏—Å–µ–∫—Å (id=unisex): 675 —Ç–æ–≤–∞—Ä–æ–≤
‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: 675
```

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:

1. –û—Ç–∫—Ä–æ–π—Ç–µ `/catalog`
2. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä "–ü–æ–ª"
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—á–µ—Ç—á–∏–∫–∏:
   - –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ `product.gender`
   - –ü—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∏–ª—å—Ç—Ä–∞ —Ç–æ–≤–∞—Ä—ã —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ** –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö  
‚úÖ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏  
‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚Äî –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ `product` –±—ã—Å—Ç—Ä–µ–µ JOIN  
‚úÖ **–¢–æ—á–Ω–æ—Å—Ç—å** ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** ‚Äî –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –≥–∏–±—Ä–∏–¥–Ω—ã–µ –ø–æ–ª—è

## –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –≥–∏–±—Ä–∏–¥–Ω—ã—Ö –ø–æ–ª–µ–π

–ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø–æ–ª–µ –∏–∑ `product` –≤ —Ñ–∏–ª—å—Ç—Ä—ã:

### 1. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª–µ –≤ —Å–ø–∏—Å–æ–∫ –≥–∏–±—Ä–∏–¥–Ω—ã—Ö:
```php
// –í FilterBuilder.php
$isProductField = in_array($characteristic['key'], [
    'gender', 'season', 'material', 'height', 'fastening', 'country',
    'your_new_field' // <-- –¥–æ–±–∞–≤—å—Ç–µ –∑–¥–µ—Å—å
]);
```

### 2. –î–æ–±–∞–≤—å—Ç–µ –º–∞–ø–ø–∏–Ω–≥ –∑–Ω–∞—á–µ–Ω–∏–π:
```php
// –í getProductFieldLabels()
'your_new_field' => [
    'value1' => '–ù–∞–∑–≤–∞–Ω–∏–µ 1',
    'value2' => '–ù–∞–∑–≤–∞–Ω–∏–µ 2',
],
```

### 3. –°–æ–∑–¥–∞–π—Ç–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:
- key: `your_new_field`
- name: "–í–∞—à–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"
- type: `select` –∏–ª–∏ `multiselect`
- is_filter: `1`

### 4. –û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à:
```bash
php yii cache/flush-all
```

## –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ `product_characteristic_value` –≤ `product`:

```php
// –ü—Ä–∏–º–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è gender
$products = Product::find()->all();
foreach ($products as $product) {
    $charValue = ProductCharacteristicValue::find()
        ->where(['product_id' => $product->id, 'characteristic_id' => 3])
        ->one();
    
    if ($charValue) {
        $value = CharacteristicValue::findOne($charValue->characteristic_value_id);
        if ($value) {
            // –ú–∞–ø–ø–∏–Ω–≥: "–ú—É–∂—Å–∫–æ–π" -> "male"
            $genderMap = [
                '–ú—É–∂—Å–∫–æ–π' => 'male',
                '–ñ–µ–Ω—Å–∫–∏–π' => 'female',
                '–£–Ω–∏—Å–µ–∫—Å' => 'unisex',
            ];
            
            $product->gender = $genderMap[$value->value] ?? 'unisex';
            $product->save(false);
        }
    }
}
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ó–∞–ø—Ä–æ—Å—ã –¥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
```sql
-- –î–ª—è –∫–∞–∂–¥–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
SELECT cv.*, COUNT(pcv.product_id) 
FROM characteristic_value cv
LEFT JOIN product_characteristic_value pcv ON ...
WHERE cv.characteristic_id = ?
GROUP BY cv.id
```

### –ó–∞–ø—Ä–æ—Å—ã –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
```sql
-- –î–ª—è –≥–∏–±—Ä–∏–¥–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ (gender, season –∏ —Ç.–¥.)
SELECT gender, COUNT(*) as count
FROM product
WHERE is_active = 1 AND gender IS NOT NULL
GROUP BY gender
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ó–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ 2-3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ ‚ö°

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

1. `/services/Catalog/FilterBuilder.php` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã:
   - `buildProductFieldFilter()`
   - `getProductFieldLabels()`
   - –û–±–Ω–æ–≤–ª–µ–Ω `buildCharacteristicsFilters()`
   - –û–±–Ω–æ–≤–ª–µ–Ω `applyFiltersToQuery()`

2. `/views/catalog/_characteristic_filter.php` ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π

3. `/controllers/CatalogController.php` ‚Äî –ø–µ—Ä–µ–¥–∞—á–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞:

```javascript
console.log('üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: –ü–æ–ª (char_3)', characteristic);
console.log('  ‚úì –£–Ω–∏—Å–µ–∫—Å: 675');
```

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–ª–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ `product`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ —É —Ç–æ–≤–∞—Ä–æ–≤
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç: `php test-hybrid-filter.php`
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `runtime/logs/app.log`

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ production
