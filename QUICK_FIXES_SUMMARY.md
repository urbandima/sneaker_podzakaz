# –ë—ã—Å—Ç—Ä–∞—è —Å–≤–æ–¥–∫–∞: –ß—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å

## üî¥ –¢–û–ü-3 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
**–§–∞–π–ª—ã:** 
- `components/SmartFilter.php` (421 —Å—Ç—Ä–æ–∫–∞)
- `services/Catalog/FilterBuilder.php` (748 —Å—Ç—Ä–æ–∫)
- `controllers/CatalogController.php` (–º–µ—Ç–æ–¥ getActiveFilters, 168 —Å—Ç—Ä–æ–∫)

**–ß—Ç–æ –¥–µ–ª–∞—é—Ç:**
- SmartFilter ‚Üí SEF URL + —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
- FilterBuilder ‚Üí –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ + –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫ –∑–∞–ø—Ä–æ—Å–∞–º
- CatalogController ‚Üí –î—É–±–ª–∏—Ä—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤

**–ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
```bash
# –£–¥–∞–ª–∏—Ç—å
rm components/SmartFilter.php

# –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª SEF URL –≤ FilterBuilder
# –£–¥–∞–ª–∏—Ç—å –º–µ—Ç–æ–¥ getActiveFilters() –∏–∑ CatalogController
```

---

### 2. –ì–∏–±—Ä–∏–¥–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
**–§–∞–π–ª—ã:**
- `models/Product.php` (–ø–æ–ª—è: gender, season, material, height, fastening, country)
- `models/CharacteristicValue.php` + `models/ProductCharacteristicValue.php`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```php
// –û–¥–Ω–∏ –∏ —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:
product.gender = 'male'                    // ‚Üê –°—Ç—Ä–æ–∫–∞, –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
characteristic_value.value = '–ú—É–∂—Å–∫–æ–π'     // ‚Üê –°—Ç—Ä–æ–∫–∞, —Ä—É—Å—Å–∫–∏–π
characteristic_value.id = 11               // ‚Üê –ß–∏—Å–ª–æ
characteristic_value.slug = 'male'         // ‚Üê –°—Ç—Ä–æ–∫–∞, –∞–Ω–≥–ª–∏–π—Å–∫–∏–π

// –ü—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è:
if (is_numeric($value)) {
    // ID ‚Üí slug ‚Üí product.gender
    $slug = CharacteristicValue::find()->where(['id' => $value])->scalar();
    $query->andWhere(['product.gender' => $slug]);
}
```

**–ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
```sql
-- –í–∞—Ä–∏–∞–Ω—Ç –ê: –£–±—Ä–∞—Ç—å –ø–æ–ª—è –∏–∑ product
ALTER TABLE product 
  DROP COLUMN gender,
  DROP COLUMN season,
  DROP COLUMN material,
  DROP COLUMN height,
  DROP COLUMN fastening,
  DROP COLUMN country;

-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ characteristic_value
```

---

### 3. –ú–µ—Ä—Ç–≤—ã–π –∫–æ–¥
**–§–∞–π–ª—ã:**
- `models/ProductCharacteristic.php` (—Å—Ç–∞—Ä–∞—è —Ç–∞–±–ª–∏—Ü–∞)
- `controllers/CatalogController.php` (–º–µ—Ç–æ–¥ actionFilterSef, –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω)

**–ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö
mysql> SELECT COUNT(*) FROM product_characteristic;

# –ï—Å–ª–∏ 0 ‚Üí —É–¥–∞–ª–∏—Ç—å
rm models/ProductCharacteristic.php
DROP TABLE product_characteristic;

# –õ–∏–±–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Ä–æ—É—Ç–∏–Ω–≥ –¥–ª—è actionFilterSef
# config/web.php:
'catalog/filter/<filters:.+>' => 'catalog/filter-sef'
```

---

## üü° –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (–º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å)

### 4. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ formatActiveFilters
**–ì–¥–µ:** 3 –º–µ—Å—Ç–∞
- SmartFilter::formatActiveFilters() - 87 —Å—Ç—Ä–æ–∫
- CatalogController::getActiveFilters() - 168 —Å—Ç—Ä–æ–∫
- web/js/catalog.js - ~50 —Å—Ç—Ä–æ–∫

**–†–µ—à–µ–Ω–∏–µ:** –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤ FilterBuilder

---

### 5. –î–≤–∞ —Ñ–æ—Ä–º–∞—Ç–∞ URL
**–ì–¥–µ:** CatalogController
- buildFilterUrl() ‚Üí `/catalog?brands=1,2&price_from=100`
- SmartFilter::generateSefUrl() ‚Üí `/catalog/filter/brand-nike/price-100-500/`

**–†–µ—à–µ–Ω–∏–µ:** –í—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω —Ñ–æ—Ä–º–∞—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è SEF)

---

## üìä –ë—ã—Å—Ç—Ä–∞—è –æ—Ü–µ–Ω–∫–∞

| –ü—Ä–æ–±–ª–µ–º–∞ | –§–∞–π–ª–æ–≤ | –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ | –í—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|----------|--------|------------|-------------------|-----------|
| –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ | 3 | ~1337 | 2-3 –¥–Ω—è | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ |
| –ì–∏–±—Ä–∏–¥–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ | 5 | ~200 | 3-4 –¥–Ω—è | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ |
| –ú–µ—Ä—Ç–≤—ã–π –∫–æ–¥ | 2 | ~100 | 1 —á–∞—Å | üü° –°—Ä–µ–¥–Ω–µ |
| –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ formatActive | 3 | ~305 | 1 –¥–µ–Ω—å | üü° –°—Ä–µ–¥–Ω–µ |
| –î–≤–∞ —Ñ–æ—Ä–º–∞—Ç–∞ URL | 1 | ~24 | 2 —á–∞—Å–∞ | üü° –°—Ä–µ–¥–Ω–µ |

**–ò—Ç–æ–≥–æ:** ~1966 —Å—Ç—Ä–æ–∫ –∏–∑–±—ã—Ç–æ—á–Ω–æ–≥–æ/–ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ –∫–æ–¥–∞

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π

### –î–µ–Ω—å 1: –ê–Ω–∞–ª–∏–∑ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
mysql> SELECT COUNT(*) FROM product WHERE gender IS NOT NULL;
mysql> SELECT COUNT(*) FROM product_characteristic;
mysql> SELECT COUNT(*) FROM product_characteristic_value WHERE characteristic_id IN (5,6,7);

# 2. –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
mysqldump -u root -p sneaker_podzakaz > backup_$(date +%Y%m%d).sql

# 3. –°–æ–∑–¥–∞—Ç—å –≤–µ—Ç–∫—É
git checkout -b refactor/filter-architecture
```

### –î–µ–Ω—å 2-3: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
```bash
# 1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å
touch services/Catalog/FilterService.php

# 2. –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–∑ SmartFilter
# 3. –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–∑ FilterBuilder
# 4. –û–±–Ω–æ–≤–∏—Ç—å CatalogController

# 5. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä–æ–µ
rm components/SmartFilter.php
```

### –î–µ–Ω—å 4-6: –ú–∏–≥—Ä–∞—Ü–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
```bash
# 1. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
./yii migrate/create migrate_product_fields_to_characteristics

# 2. –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ
# 3. –û–±–Ω–æ–≤–∏—Ç—å FilterService
# 4. –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—è –∏–∑ product

# 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
./yii test/run
```

### –î–µ–Ω—å 7: –û—á–∏—Å—Ç–∫–∞
```bash
# 1. –£–¥–∞–ª–∏—Ç—å –º–µ—Ä—Ç–≤—ã–π –∫–æ–¥
rm models/ProductCharacteristic.php

# 2. –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã
# 3. –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

# 4. –ö–æ–º–º–∏—Ç
git add .
git commit -m "refactor: —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏"
git push origin refactor/filter-architecture
```

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Å—Ä–æ—á–Ω–æ)

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ (2-3 —á–∞—Å–∞)

```php
// 1. –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ formatActiveFilters
// –í CatalogController.php –∑–∞–º–µ–Ω–∏—Ç—å:
$activeFilters = $this->getActiveFilters($currentFilters);
// –ù–∞:
$activeFilters = FilterBuilder::formatActiveFilters($currentFilters);

// 2. –£–¥–∞–ª–∏—Ç—å –º–µ—Ç–æ–¥ getActiveFilters() –∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ (168 —Å—Ç—Ä–æ–∫)

// 3. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –≤ FilterBuilder:
public static function formatActiveFilters($filters) {
    // –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –∏–∑ CatalogController::getActiveFilters
    // + –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
}

// 4. –£–¥–∞–ª–∏—Ç—å SmartFilter::formatActiveFilters() (87 —Å—Ç—Ä–æ–∫)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ ~255 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞, —É–±—Ä–∞–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üìù –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º

- [ ] –°–æ–∑–¥–∞–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –ë–î
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö
- [ ] –°–æ–∑–¥–∞–Ω–∞ –≤–µ—Ç–∫–∞ –≤ git
- [ ] –ù–∞–ø–∏—Å–∞–Ω—ã —Ç–µ—Å—Ç—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
- [ ] –ö–æ–º–∞–Ω–¥–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∞ –æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ
- [ ] –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –≤—Ä–µ–º—è –Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## ‚ö†Ô∏è –†–∏—Å–∫–∏

1. **–ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö:** –ú–∏–≥—Ä–∞—Ü–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö
   - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è + —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ staging

2. **–ü–æ–ª–æ–º–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:** –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
   - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –ê–≤—Ç–æ—Ç–µ—Å—Ç—ã + —Ä—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π

3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** JOIN —Å characteristic_value –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ
   - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –ò–Ω–¥–µ–∫—Å—ã + –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ + –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

4. **SEO:** –ò–∑–º–µ–Ω–µ–Ω–∏–µ URL –º–æ–∂–µ—Ç –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é
   - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** 301 —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ sitemap

---

## üí° –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–µ—Å–ª–∏ –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏)

### –í–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:

1. **–û—Å—Ç–∞–≤–∏—Ç—å –≥–∏–±—Ä–∏–¥–Ω—É—é —Å–∏—Å—Ç–µ–º—É**, –Ω–æ:
   - –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è
   - –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –º–∞–ø–ø–∏–Ω–≥ ID ‚Üí slug
   - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∏–ø–∞

2. **–û—Å—Ç–∞–≤–∏—Ç—å –æ–±–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞**, –Ω–æ:
   - –ß–µ—Ç–∫–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
   - –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–≥–¥–∞ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
   - –£–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ —è–≤–Ω–æ–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

3. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è:**
   - –ù–æ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ ‚Üí —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ characteristic_value
   - –°—Ç–∞—Ä—ã–µ ‚Üí –æ—Å—Ç–∞–≤–∏—Ç—å –≤ product –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏
   - –ß–µ—Ä–µ–∑ 6 –º–µ—Å—è—Ü–µ–≤ ‚Üí –ø–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

**–ü–ª—é—Å—ã:** –ú–µ–Ω—å—à–µ —Ä–∏—Å–∫–æ–≤, –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ  
**–ú–∏–Ω—É—Å—ã:** –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥ –æ—Å—Ç–∞–µ—Ç—Å—è
