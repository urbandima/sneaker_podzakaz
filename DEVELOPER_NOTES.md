# üîß –ó–∞–º–µ—Ç–∫–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

### MVC —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (Yii2)
- **Models** (`models/`) - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏ —Ä–∞–±–æ—Ç–∞ —Å –ë–î
- **Views** (`views/`) - –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (HTML + PHP)
- **Controllers** (`controllers/`) - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### –ú–æ–¥–µ–ª–∏
- `User` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å —Ä–æ–ª—è–º–∏ (admin, manager, logist)
- `Order` - –∑–∞–∫–∞–∑—ã —Å —Ç–æ–∫–µ–Ω–∞–º–∏ –∏ –ø—É–±–ª–∏—á–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏
- `OrderItem` - –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–æ–≤ (—Ç–æ–≤–∞—Ä—ã)
- `OrderHistory` - –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–æ–≤
- `LoginForm` - —Ñ–æ—Ä–º–∞ –≤—Ö–æ–¥–∞

#### –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
- `SiteController` - –≤—Ö–æ–¥/–≤—ã—Ö–æ–¥, –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
- `AdminController` - –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (CRUD –∑–∞–∫–∞–∑–æ–≤, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
- `OrderController` - –ø—É–±–ª–∏—á–Ω–∞—è —á–∞—Å—Ç—å (–ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–∫–∞–∑–∞, –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞)

#### –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
- `layouts/main.php` - –æ—Å–Ω–æ–≤–Ω–æ–π layout –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
- `layouts/public.php` - layout –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–π —á–∞—Å—Ç–∏
- `admin/*` - –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
- `order/view.php` - –ø—É–±–ª–∏—á–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–∫–∞–∑–∞
- `site/login.php` - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞

---

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –°—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü

```sql
user
‚îú‚îÄ‚îÄ id (PK)
‚îú‚îÄ‚îÄ username (unique)
‚îú‚îÄ‚îÄ email (unique)
‚îú‚îÄ‚îÄ password_hash
‚îú‚îÄ‚îÄ auth_key
‚îú‚îÄ‚îÄ role (admin|manager|logist)
‚îú‚îÄ‚îÄ status
‚îú‚îÄ‚îÄ created_at
‚îî‚îÄ‚îÄ updated_at

order
‚îú‚îÄ‚îÄ id (PK)
‚îú‚îÄ‚îÄ order_number (unique, —Ñ–æ—Ä–º–∞—Ç: YYYY-00001)
‚îú‚îÄ‚îÄ token (unique, –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–π —Å—Å—ã–ª–∫–∏)
‚îú‚îÄ‚îÄ client_name
‚îú‚îÄ‚îÄ client_phone
‚îú‚îÄ‚îÄ client_email
‚îú‚îÄ‚îÄ total_amount
‚îú‚îÄ‚îÄ status
‚îú‚îÄ‚îÄ delivery_date
‚îú‚îÄ‚îÄ payment_proof (–ø—É—Ç—å –∫ —Ñ–∞–π–ª—É)
‚îú‚îÄ‚îÄ payment_uploaded_at
‚îú‚îÄ‚îÄ offer_accepted
‚îú‚îÄ‚îÄ offer_accepted_at
‚îú‚îÄ‚îÄ created_by (FK -> user.id)
‚îú‚îÄ‚îÄ assigned_logist (FK -> user.id, nullable)
‚îú‚îÄ‚îÄ created_at
‚îî‚îÄ‚îÄ updated_at

order_item
‚îú‚îÄ‚îÄ id (PK)
‚îú‚îÄ‚îÄ order_id (FK -> order.id)
‚îú‚îÄ‚îÄ product_name
‚îú‚îÄ‚îÄ quantity
‚îú‚îÄ‚îÄ price
‚îú‚îÄ‚îÄ total
‚îî‚îÄ‚îÄ created_at

order_history
‚îú‚îÄ‚îÄ id (PK)
‚îú‚îÄ‚îÄ order_id (FK -> order.id)
‚îú‚îÄ‚îÄ old_status
‚îú‚îÄ‚îÄ new_status
‚îú‚îÄ‚îÄ comment
‚îú‚îÄ‚îÄ changed_by (FK -> user.id, nullable)
‚îî‚îÄ‚îÄ created_at

auth_* (RBAC —Ç–∞–±–ª–∏—Ü—ã)
```

---

## –ö–æ–Ω—Å–æ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –ú–∏–≥—Ä–∞—Ü–∏–∏
```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏
php yii migrate

# –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é
php yii migrate/down

# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é
php yii migrate/create migration_name

# –ò—Å—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
php yii migrate/history
```

### –ö–µ—à
```bash
# –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à
php yii cache/flush-all
```

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è CRUD (Gii)
```bash
# –û—Ç–∫—Ä—ã—Ç—å Gii –≤ –±—Ä–∞—É–∑–µ—Ä–µ
http://localhost:8080/gii

# –ò–ª–∏ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å
php yii gii/model --tableName=table_name
```

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î (`config/db.php`)
```php
return [
    'class' => 'yii\db\Connection',
    'dsn' => 'mysql:host=localhost;dbname=order_management',
    'username' => 'root',
    'password' => '',
    'charset' => 'utf8mb4',
];
```

### Email (`config/web.php`)
```php
'mailer' => [
    'class' => 'yii\symfonymailer\Mailer',
    'useFileTransport' => true, // false –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
],
```

### URL –ø—Ä–∞–≤–∏–ª–∞ (`config/web.php`)
```php
'urlManager' => [
    'enablePrettyUrl' => true,
    'showScriptName' => false,
    'rules' => [
        'order/<token>' => 'order/view',
        'admin/orders' => 'admin/orders',
        // ...
    ],
],
```

---

## –†–∞–±–æ—Ç–∞ —Å –º–æ–¥–µ–ª—è–º–∏

### –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
```php
$order = new Order();
$order->client_name = '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω';
$order->created_by = Yii::$app->user->id;
$order->save(); // –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è order_number –∏ token
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
```php
$item = new OrderItem();
$item->order_id = $order->id;
$item->product_name = '–ö—Ä–æ—Å—Å–æ–≤–∫–∏';
$item->quantity = 1;
$item->price = 300.00;
$item->save(); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–µ—Ç—Å—è total
```

### –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞ –ø–æ —Ç–æ–∫–µ–Ω—É
```php
$order = Order::findOne(['token' => $token]);
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
```php
$order->status = 'paid';
$order->save(); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ order_history
```

---

## –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ
```php
$user = Yii::$app->user->identity;

if ($user->isAdmin()) {
    // –î–µ–π—Å—Ç–≤–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
}

if ($user->isLogist()) {
    // –î–µ–π—Å—Ç–≤–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–≥–∏—Å—Ç–∞
}
```

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ behaviors
```php
public function behaviors()
{
    return [
        'access' => [
            'class' => AccessControl::class,
            'rules' => [
                [
                    'allow' => true,
                    'roles' => ['@'], // –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ
                ],
            ],
        ],
    ];
}
```

---

## –°–æ–±—ã—Ç–∏—è –∏ —Ö—É–∫–∏

### beforeSave (Order –º–æ–¥–µ–ª—å)
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞

### afterSave (Order –º–æ–¥–µ–ª—å)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–∞
- –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### beforeSave (OrderItem –º–æ–¥–µ–ª—å)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã (`total = quantity * price`)

---

## –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤

### –ü—É—Ç—å –∫ —Ñ–∞–π–ª–∞–º
```
/web/uploads/payments/
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
```php
$file = UploadedFile::getInstanceByName('payment_proof');
$fileName = $order->id . '_' . time() . '.' . $file->extension;
$file->saveAs($uploadPath . $fileName);
```

---

## Email —à–∞–±–ª–æ–Ω—ã

### –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ
```
/mail/order-created.php
/mail/payment-uploaded.php
```

### –û—Ç–ø—Ä–∞–≤–∫–∞
```php
Yii::$app->mailer->compose('order-created', ['order' => $model])
    ->setFrom([Yii::$app->params['senderEmail'] => Yii::$app->params['senderName']])
    ->setTo($model->client_email)
    ->setSubject('–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω')
    ->send();
```

---

## –û—Ç–ª–∞–¥–∫–∞

### –í–∫–ª—é—á–µ–Ω–∏–µ Debug –ø–∞–Ω–µ–ª–∏
–£–∂–µ –≤–∫–ª—é—á–µ–Ω–æ –≤ `dev` —Ä–µ–∂–∏–º–µ: http://localhost:8080/debug

### –õ–æ–≥–∏
```
runtime/logs/app.log
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä SQL –∑–∞–ø—Ä–æ—Å–æ–≤
```php
Yii::$app->db->enableLogging = true;
Yii::$app->db->enableProfiling = true;
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å
```php
// –°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ commands/TestController.php
public function actionCreateOrder()
{
    $order = new Order();
    $order->client_name = 'Test Client';
    $order->client_email = 'test@example.com';
    $order->created_by = 1;
    $order->save();
    
    echo "–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω: " . $order->order_number . "\n";
    echo "–°—Å—ã–ª–∫–∞: " . $order->getPublicUrl() . "\n";
}

// –ó–∞–ø—É—Å–∫
php yii test/create-order
```

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### CSRF —Ç–æ–∫–µ–Ω
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º—ã —á–µ—Ä–µ–∑ `ActiveForm`

### SQL –∏–Ω—ä–µ–∫—Ü–∏–∏
Yii2 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö

### XSS
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `Html::encode()` –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

### –í–∞–ª–∏–¥–∞—Ü–∏—è
```php
public function rules()
{
    return [
        [['client_name', 'client_email'], 'required'],
        ['client_email', 'email'],
        ['total_amount', 'number', 'min' => 0],
    ];
}
```

---

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### Eager Loading
```php
// –í–º–µ—Å—Ç–æ N+1 –∑–∞–ø—Ä–æ—Å–æ–≤
Order::find()->with(['creator', 'logist', 'orderItems'])->all();
```

### –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
```php
$data = Yii::$app->cache->get('key');
if ($data === false) {
    $data = // –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
    Yii::$app->cache->set('key', $data, 3600);
}
```

---

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
1. –î–æ–±–∞–≤–∏—Ç—å –≤ `config/params.php`:
```php
'orderStatuses' => [
    'new_status' => '–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞',
],
```

2. –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ `Order::canChangeStatus()`

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ä–æ–ª–∏
1. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É –≤ `User` –º–æ–¥–µ–ª—å
2. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π –º–µ—Ç–æ–¥ (`isNewRole()`)
3. –û–±–Ω–æ–≤–∏—Ç—å `behaviors()` –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è –≤ –∑–∞–∫–∞–∑
1. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:
```bash
php yii migrate/create add_field_to_order
```

2. –î–æ–±–∞–≤–∏—Ç—å –≤ `rules()` –∏ `attributeLabels()` –º–æ–¥–µ–ª–∏

3. –î–æ–±–∞–≤–∏—Ç—å –≤ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è

---

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Yii2 Docs](https://www.yiiframework.com/doc/guide/2.0/ru)
- [Yii2 API](https://www.yiiframework.com/doc/api/2.0)
- [Bootstrap 5](https://getbootstrap.com/docs/5.0)
- [Bootstrap Icons](https://icons.getbootstrap.com/)

---

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –û—à–∏–±–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ runtime
```bash
chmod -R 777 runtime web/assets web/uploads
```

### –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç pretty URL
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `.htaccess` –≤ `web/` –∏ mod_rewrite –≤–∫–ª—é—á–µ–Ω

### Email –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è
–í dev —Ä–µ–∂–∏–º–µ –æ–Ω–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `runtime/mail/`. –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏:
```php
'mailer' => [
    'useFileTransport' => false,
    'transport' => [
        'dsn' => 'smtp://user:pass@smtp.example.com:587',
    ],
],
```
