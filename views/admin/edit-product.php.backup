<?php

use yii\helpers\Html;
use yii\widgets\ActiveForm;
use yii\bootstrap5\Tabs;

/** @var yii\web\View $this */
/** @var app\models\Product $product */
/** @var array $brands */
/** @var array $categories */

$this->title = 'Редактирование товара: ' . $product->name;
$this->params['breadcrumbs'][] = ['label' => 'Товары', 'url' => ['products']];
$this->params['breadcrumbs'][] = ['label' => $product->name, 'url' => ['view-product', 'id' => $product->id]];
$this->params['breadcrumbs'][] = 'Редактирование';
?>

<div class="product-edit">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-pencil-square"></i> <?= Html::encode($product->name) ?></h1>
        <div class="btn-group">
            <?= Html::a('<i class="bi bi-eye"></i> Просмотр', ['view-product', 'id' => $product->id], ['class' => 'btn btn-outline-primary']) ?>
            <?= Html::a('<i class="bi bi-arrow-left"></i> К списку', ['products'], ['class' => 'btn btn-secondary']) ?>
        </div>
    </div>

    <?php if ($product->hasAttribute('poizon_id') && $product->poizon_id): ?>
    <div class="alert alert-info alert-dismissible fade show">
        <i class="bi bi-cloud-download fs-5"></i>
        <strong>Товар из Poizon</strong> - некоторые поля синхронизируются автоматически.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <?php endif; ?>

    <?php $form = ActiveForm::begin(['id' => 'product-form']); ?>

    <div class="card">
        <div class="card-body p-0"><?php
            $items = [];
            
            // ===== ВКЛАДКА 1: Основная информация =====
            ob_start();
            ?>
            <div class="p-4">
                <h5 class="mb-4"><i class="bi bi-info-circle text-primary"></i> Основная информация</h5>

                <?= $form->field($product, 'name')->textInput([
                    'maxlength' => true,
                    'placeholder' => 'Название товара',
                    'class' => 'form-control form-control-lg'
                ])->label('Название товара') ?>

                <?= $form->field($product, 'slug')->textInput([
                    'maxlength' => true,
                    'placeholder' => 'nike-dunk-low-white'
                ])->hint('URL-адрес товара (автоматически генерируется из названия)') ?>

                    <div class="row">
                        <div class="col-md-6">
                            <?= $form->field($product, 'sku')->textInput([
                                'maxlength' => true,
                                'placeholder' => 'SKU-12345'
                            ])->label('SKU (артикул)') ?>
                        </div>
                        <?php if ($product->hasAttribute('vendor_code')): ?>
                        <div class="col-md-6">
                            <?= $form->field($product, 'vendor_code')->textInput([
                                'maxlength' => true,
                                'placeholder' => 'ABC-123'
                            ])->label('Код производителя') ?>
                        </div>
                        <?php endif; ?>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <?= $form->field($product, 'brand_id')->dropDownList(
                                \yii\helpers\ArrayHelper::map($brands, 'id', 'name'),
                                ['prompt' => 'Выберите бренд']
                            )->label('Бренд') ?>
                        </div>
                        <div class="col-md-6">
                            <?= $form->field($product, 'category_id')->dropDownList(
                                \yii\helpers\ArrayHelper::map($categories, 'id', 'name'),
                                ['prompt' => 'Выберите категорию']
                            )->label('Категория') ?>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <?= $form->field($product, 'price')->textInput([
                                'type' => 'number',
                                'step' => '0.01',
                                'min' => '0',
                                'placeholder' => '99.99'
                            ])->label('Цена (BYN)') ?>
                        </div>
                        <div class="col-md-6">
                            <?php if ($product->hasAttribute('poizon_id') && $product->poizon_id): ?>
                                <?= $form->field($product, 'poizon_price_cny')->textInput([
                                    'type' => 'number',
                                    'step' => '0.01',
                                    'readonly' => true
                                ])->label('Цена Poizon (CNY)')->hint('Обновляется автоматически') ?>
                            <?php endif; ?>
                        </div>
                    </div>

                    <?= $form->field($product, 'description')->textarea([
                        'rows' => 6,
                        'placeholder' => 'Описание товара...'
                    ])->label('Описание') ?>

                    <div class="row">
                        <div class="col-md-6">
                            <?= $form->field($product, 'is_active')->checkbox([
                                'label' => 'Товар активен (отображается на сайте)'
                            ]) ?>
                        </div>
                        <?php if ($product->hasAttribute('is_limited')): ?>
                        <div class="col-md-6">
                            <?= $form->field($product, 'is_limited')->checkbox([
                                'label' => 'Лимитированная модель'
                            ]) ?>
                        </div>
                        <?php endif; ?>
                    </div>
                    
                    <?php if ($product->hasAttribute('purchase_price')): ?>
                    <div class="row">
                        <div class="col-md-6">
                            <?= $form->field($product, 'purchase_price')->textInput([
                                'type' => 'number',
                                'step' => '0.01',
                                'min' => '0',
                                'placeholder' => '85.00'
                            ])->label('Закупочная цена (BYN)')->hint('Цена закупки товара') ?>
                        </div>
                        <div class="col-md-6">
                            <?= $form->field($product, 'stock_count')->textInput([
                                'type' => 'number',
                                'min' => '0',
                                'placeholder' => '10'
                            ])->label('Количество на складе')->hint('0 = под заказ') ?>
                        </div>
                    </div>
                    <?php endif; ?>
                    </div>

                </div>
            </div>

            <!-- Характеристики обуви -->
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> Характеристики обуви</h5>
                </div>
                <div class="card-body">
                    <?php if ($product->hasAttribute('upper_material')): ?>
                    <div class="row">
                        <div class="col-md-6">
                            <?= $form->field($product, 'upper_material')->textInput([
                                'maxlength' => true,
                                'placeholder' => 'Кожа, замша, текстиль'
                            ])->label('Материал верха') ?>
                        </div>
                        <div class="col-md-6">
                            <?= $form->field($product, 'sole_material')->textInput([
                                'maxlength' => true,
                                'placeholder' => 'Резина, EVA'
                            ])->label('Материал подошвы') ?>
                        </div>
                    </div>

                    <?= $form->field($product, 'color_description')->textInput([
                        'maxlength' => true,
                        'placeholder' => 'Черный/Белый'
                    ])->label('Описание цвета') ?>
                    <?php endif; ?>

                    <div class="row">
                        <div class="col-md-4">
                            <?= $form->field($product, 'style_code')->textInput([
                                'maxlength' => true,
                                'placeholder' => 'DM0029-100'
                            ])->label('Код стиля/модели') ?>
                        </div>
                        <div class="col-md-4">
                            <?= $form->field($product, 'release_year')->textInput([
                                'type' => 'number',
                                'min' => '1900',
                                'max' => date('Y'),
                                'placeholder' => date('Y')
                            ])->label('Год выпуска') ?>
                        </div>
                        <div class="col-md-4">
                            <?= $form->field($product, 'weight')->textInput([
                                'type' => 'number',
                                'min' => '0',
                                'placeholder' => '350'
                            ])->label('Вес (граммы)') ?>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Кнопки действий -->
            <div class="card mt-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <?= Html::submitButton('<i class="bi bi-check-circle"></i> Сохранить изменения', [
                                'class' => 'btn btn-success btn-lg'
                            ]) ?>
                            <?= Html::a('<i class="bi bi-x-circle"></i> Отмена', ['view-product', 'id' => $product->id], [
                                'class' => 'btn btn-secondary btn-lg'
                            ]) ?>
                        </div>
                        <div>
                            <?= Html::a('<i class="bi bi-trash"></i> Удалить товар', ['delete-product', 'id' => $product->id], [
                                'class' => 'btn btn-outline-danger',
                                'data-method' => 'post',
                                'data-confirm' => 'Вы уверены, что хотите удалить этот товар? Это действие нельзя отменить.'
                            ]) ?>
                        </div>
                    </div>
                </div>
            </div>

            <?php ActiveForm::end(); ?>

        </div>

        <!-- Правая колонка: дополнительная информация -->
        <div class="col-lg-4">
            
            <?php if ($product->poizon_id): ?>
            <!-- Информация Poizon -->
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="bi bi-cloud-download"></i> Информация Poizon</h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm mb-0">
                        <tr>
                            <th>Poizon ID:</th>
                            <td><?= Html::encode($product->poizon_id) ?></td>
                        </tr>
                        <tr>
                            <th>SPU ID:</th>
                            <td><?= Html::encode($product->poizon_spu_id) ?></td>
                        </tr>
                        <?php if ($product->poizon_url): ?>
                        <tr>
                            <th>Ссылка:</th>
                            <td><?= Html::a('Открыть', $product->poizon_url, [
                                'target' => '_blank',
                                'class' => 'btn btn-sm btn-outline-primary'
                            ]) ?></td>
                        </tr>
                        <?php endif; ?>
                        <tr>
                            <th>Последняя синхр.:</th>
                            <td>
                                <?php if ($product->last_sync_at): ?>
                                    <small><?= Yii::$app->formatter->asDatetime($product->last_sync_at) ?></small>
                                <?php else: ?>
                                    <span class="text-danger">Не синхронизирован</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                    </table>
                    
                    <?= Html::a('<i class="bi bi-arrow-repeat"></i> Синхронизировать сейчас', ['sync-product', 'id' => $product->id], [
                        'class' => 'btn btn-info btn-sm w-100 mt-2',
                        'data-method' => 'post'
                    ]) ?>
                </div>
            </div>
            <?php endif; ?>

            <!-- Размеры -->
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-rulers"></i> Размеры товара</h6>
                </div>
                <div class="card-body">
                    <?php 
                    $sizesCount = $product->getSizes()->count();
                    $availableSizes = $product->getSizes()->where(['is_available' => 1])->count();
                    ?>
                    
                    <div class="mb-3">
                        <strong>Всего размеров:</strong> <?= $sizesCount ?><br>
                        <strong>Доступно:</strong> <?= $availableSizes ?>
                    </div>

                    <?php if ($sizesCount > 0): ?>
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Для управления размерами перейдите на страницу просмотра товара
                        </small>
                    <?php else: ?>
                        <div class="alert alert-warning mb-0">
                            <small><i class="bi bi-exclamation-triangle"></i> У товара нет размеров</small>
                        </div>
                    <?php endif; ?>
                </div>
            </div>

            <!-- Изображения -->
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-images"></i> Изображения</h6>
                </div>
                <div class="card-body">
                    <?php 
                    $imagesCount = $product->getImages()->count();
                    ?>
                    
                    <div class="mb-3">
                        <strong>Загружено:</strong> <?= $imagesCount ?> изображений
                    </div>

                    <?php if ($imagesCount > 0): ?>
                        <div class="row g-2">
                            <?php foreach ($product->images as $image): ?>
                                <div class="col-6">
                                    <img src="<?= $image->getImageUrl() ?>" class="img-thumbnail" alt="">
                                </div>
                            <?php endforeach; ?>
                        </div>
                    <?php else: ?>
                        <div class="alert alert-warning mb-0">
                            <small><i class="bi bi-exclamation-triangle"></i> Нет изображений</small>
                        </div>
                    <?php endif; ?>
                </div>
            </div>

            <!-- Метаинформация -->
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-clock-history"></i> Метаинформация</h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm mb-0">
                        <tr>
                            <th>ID:</th>
                            <td><?= $product->id ?></td>
                        </tr>
                        <tr>
                            <th>Создан:</th>
                            <td><small><?= Yii::$app->formatter->asDatetime($product->created_at) ?></small></td>
                        </tr>
                        <tr>
                            <th>Обновлен:</th>
                            <td><small><?= Yii::$app->formatter->asDatetime($product->updated_at) ?></small></td>
                        </tr>
                    </table>
                </div>
            </div>

        </div>
    </div>

</div>

<style>
    .card {
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: none;
    }
    
    .card-header {
        border-bottom: 2px solid #e9ecef;
    }
    
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
    }
    
    .btn-success:hover {
        background: linear-gradient(135deg, #5568d3 0%, #65398b 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
</style>
