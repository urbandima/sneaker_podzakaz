# üîí –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–î–∞—Ç–∞:** 25 –æ–∫—Ç—è–±—Ä—è 2025  
**–ê–≤—Ç–æ—Ä:** Senior Full-Stack Team  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã

---

## üìä –°–≤–æ–¥–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

| ‚Ññ | –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –°—Ç–∞—Ç—É—Å |
|---|----------|-----------|--------|
| 1 | CSRF-—É—è–∑–≤–∏–º–æ—Å—Ç—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–ø–ª–∞—Ç—ã | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 2 | –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤ | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 3 | Race condition –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–æ–≤ | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 4 | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ | üü† –í—ã—Å–æ–∫–∏–π | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 5 | –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤ | üü† –í—ã—Å–æ–∫–∏–π | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 6 | –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ | üü† –í—ã—Å–æ–∫–∏–π | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 7 | –£—Å—Ç–∞—Ä–µ–≤—à–∏–π API –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è | üü° –°—Ä–µ–¥–Ω–∏–π | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 8 | –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ email | üü° –°—Ä–µ–¥–Ω–∏–π | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 9 | –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ø–∞–º–∞ | üü° –°—Ä–µ–¥–Ω–∏–π | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 10 | –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è | üü° –°—Ä–µ–¥–Ω–∏–π | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |

---

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. CSRF-–∑–∞—â–∏—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**  
`controllers/OrderController.php` –æ—Ç–∫–ª—é—á–∞–ª CSRF-–∑–∞—â–∏—Ç—É –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π:
```php
$this->enableCsrfValidation = false; // ‚ùå –û–ü–ê–°–ù–û!
```

**–†–µ—à–µ–Ω–∏–µ:**
- –í–∫–ª—é—á–µ–Ω–∞ CSRF-–∑–∞—â–∏—Ç–∞ –¥–ª—è –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã Yii2 –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º
- CSRF-—Ç–æ–∫–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º—ã

**–§–∞–π–ª—ã:**
- `controllers/OrderController.php` (—Å—Ç—Ä–æ–∫–∏ 17-21)

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –º–µ–∂—Å–∞–π—Ç–æ–≤–æ–π –ø–æ–¥–¥–µ–ª–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

---

### 2. –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–ö–ª–∏–µ–Ω—Ç –º–æ–≥ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –ª—é–±–æ–≥–æ —Ç–∏–ø–∞ –∏ —Ä–∞–∑–º–µ—Ä–∞ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–æ–∫.

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–ª–µ–Ω–∞ –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞:** –º–∞–∫—Å–∏–º—É–º 5 –ú–ë
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:** —Ç–æ–ª—å–∫–æ jpg, jpeg, png, pdf, gif, webp
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ MIME-—Ç–∏–ø–∞:** –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Ñ–∞–π–ª–∞
4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ magic bytes:** —Ä–µ–∞–ª—å–Ω—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ `finfo`

```php
private function validateUploadedFile($file): array
{
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
    if ($file->size > 5 * 1024 * 1024) {
        $errors[] = '–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5 –ú–ë.';
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
    if (!in_array(strtolower($file->extension), ['jpg', 'jpeg', 'png', 'pdf', 'gif', 'webp'])) {
        $errors[] = '–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.';
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ MIME –∏ magic bytes
    $finfo = finfo_open(FILEINFO_MIME_TYPE);
    $realMimeType = finfo_file($finfo, $file->tempName);
    // ...
}
```

**–§–∞–π–ª—ã:**
- `controllers/OrderController.php` (—Å—Ç—Ä–æ–∫–∏ 149-193)

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç RCE, –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∏—Å–∫–∞, –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

---

### 3. Race Condition –≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–ü—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–æ–≤ –º–æ–≥–ª–∏ –ø–æ–ª—É—á–∏—Ç—å—Å—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞.

**–†–µ—à–µ–Ω–∏–µ:**
–ê—Ç–æ–º–∞—Ä–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:

```php
protected function generateOrderNumber()
{
    $maxRetries = 5;
    while ($attempt < $maxRetries) {
        $transaction = Yii::$app->db->beginTransaction();
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑
        $lastOrder = self::find()
            ->where(['like', 'order_number', $year])
            ->orderBy(['id' => SORT_DESC])
            ->limit(1)
            ->createCommand()
            ->queryOne();
        
        $orderNumber = sprintf('%s-%05d', $year, $newNumber);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
        if (!self::find()->where(['order_number' => $orderNumber])->exists()) {
            $transaction->commit();
            return $orderNumber;
        }
        
        $transaction->rollBack();
        usleep(rand(10000, 50000)); // –ó–∞–¥–µ—Ä–∂–∫–∞ 10-50ms
    }
}
```

**–§–∞–π–ª—ã:**
- `models/Order.php` (—Å—Ç—Ä–æ–∫–∏ 106-158)

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–æ–º–µ—Ä–æ–≤ –∑–∞–∫–∞–∑–æ–≤

---

## üü† –í—ã—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 4. –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–°—Ç–∞—Ç—É—Å—ã —Ö—Ä–∞–Ω–∏–ª–∏—Å—å –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:
- `config/params.php` (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
- –¢–∞–±–ª–∏—Ü–∞ `order_status` (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ë–î)

**–†–µ—à–µ–Ω–∏–µ:**
–ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `Settings`:

```php
// –í–µ–∑–¥–µ –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞:
Yii::$app->settings->getStatuses()  // –≤–º–µ—Å—Ç–æ Yii::$app->params['orderStatuses']
Yii::$app->settings->getLogistStatuses()  // –≤–º–µ—Å—Ç–æ Yii::$app->params['logistStatuses']
```

**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:**
- `controllers/AdminController.php` (—Å—Ç—Ä–æ–∫–∞ 321)
- `views/admin/view-order.php` (—Å—Ç—Ä–æ–∫–∞ 147)
- `views/admin/update-order.php` (—Å—Ç—Ä–æ–∫–∞ 44)
- `models/OrderHistory.php` (—Å—Ç—Ä–æ–∫–∏ 54, 60)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –û–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∞–¥–º–∏–Ω–∫–µ —Å—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –≤–µ–∑–¥–µ
- ‚úÖ –ù–µ—Ç –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –¥–∞–Ω–Ω—ã—Ö

---

### 5. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–§–∞–π–ª –º–æ–≥ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è, –∞ –∑–∞–ø–∏—Å—å –≤ –ë–î –Ω–µ –æ–±–Ω–æ–≤–∏—Ç—å—Å—è, –∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç.

**–†–µ—à–µ–Ω–∏–µ:**
–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:

```php
$transaction = Yii::$app->db->beginTransaction();
try {
    // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
    $file->saveAs($filePath);
    
    // 2. –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–µ–ª—å
    $model->payment_proof = '/uploads/payments/' . $fileName;
    $model->status = 'paid';
    $model->save();
    
    // 3. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
    $history->save();
    
    // 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email
    Yii::$app->mailer->send();
    
    $transaction->commit();
} catch (\Exception $e) {
    $transaction->rollBack();
    // –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –µ—Å–ª–∏ –±—ã–ª —Å–æ–∑–¥–∞–Ω
    @unlink($filePath);
}
```

**–§–∞–π–ª—ã:**
- `controllers/OrderController.php` (—Å—Ç—Ä–æ–∫–∏ 72-140)

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π, –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

---

### 6. –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–ö–ª–∏–µ–Ω—Ç –º–æ–≥ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π:
```php
if ($model->payment_proof) {
    Yii::$app->session->setFlash('error', '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ.');
    return $this->redirect(['view', 'token' => $token]);
}
```

2. Rate Limiting:
```php
private function checkRateLimit($token): void
{
    $attempts = $session->get('upload_attempts_' . $token, 0);
    if ($attempts >= 5) {
        throw new BadRequestHttpException('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫.');
    }
    $session->set('upload_attempts_' . $token, $attempts + 1);
}
```

**–§–∞–π–ª—ã:**
- `controllers/OrderController.php` (—Å—Ç—Ä–æ–∫–∏ 45-52, 195-217)

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏, –∑–∞—â–∏—Ç–∞ –æ—Ç DoS

---

## üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

### 7. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ API –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:**  
`document.execCommand('copy')` —É—Å—Ç–∞—Ä–µ–ª –∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö.

**–†–µ—à–µ–Ω–∏–µ:**
–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π `navigator.clipboard` API —Å fallback:

```javascript
function copyLink() {
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(link.value).then(function() {
            showCopyNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
        }).catch(function(err) {
            fallbackCopy(link);
        });
    } else {
        fallbackCopy(link);
    }
}
```

**–§–∞–π–ª—ã:**
- `views/admin/view-order.php` (—Å—Ç—Ä–æ–∫–∏ 227-266)
- `views/order/view.php` (—Å—Ç—Ä–æ–∫–∏ 307-378)

**UX:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –≤–æ –≤—Å–µ—Ö —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö, –≤–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å

---

### 8. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ email

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ email –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª—Å—è.

**–†–µ—à–µ–Ω–∏–µ:**
–ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:

```php
try {
    $sent = Yii::$app->mailer->compose('order-created', ['order' => $this])
        ->setTo($this->client_email)
        ->send();
    
    if ($sent) {
        Yii::info('Email —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è –∑–∞–∫–∞–∑–∞ #' . $this->id, 'order');
        return true;
    } else {
        Yii::warning('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å email –¥–ª—è –∑–∞–∫–∞–∑–∞ #' . $this->id, 'order');
        return false;
    }
} catch (\Exception $e) {
    Yii::error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email: ' . $e->getMessage(), 'order');
    return false;
}
```

**–§–∞–π–ª—ã:**
- `models/Order.php` (—Å—Ç—Ä–æ–∫–∏ 198-227)
- `controllers/OrderController.php` (—Å—Ç—Ä–æ–∫–∏ 104-117)

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** ‚úÖ –í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —Å email —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –≤ –ª–æ–≥–∞—Ö

---

### 9. Rate Limiting –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç –º–∞—Å—Å–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:**
–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: 5 –ø–æ–ø—ã—Ç–æ–∫ –≤ 15 –º–∏–Ω—É—Ç –Ω–∞ —Ç–æ–∫–µ–Ω:

```php
private function checkRateLimit($token): void
{
    $attempts = $session->get('upload_attempts_' . $token, 0);
    $lastAttempt = $session->get('upload_attempts_' . $token . '_time', 0);
    
    // –°–±—Ä–æ—Å —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç
    if (time() - $lastAttempt > 900) {
        $attempts = 0;
    }
    
    if ($attempts >= 5) {
        Yii::warning('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –¥–ª—è —Ç–æ–∫–µ–Ω–∞: ' . $token, 'security');
        throw new BadRequestHttpException('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç.');
    }
}
```

**–§–∞–π–ª—ã:**
- `controllers/OrderController.php` (—Å—Ç—Ä–æ–∫–∏ 195-217)

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç DoS –∏ —Å–ø–∞–º–∞

---

### 10. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ø—ã—Ç–æ–∫ –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞.

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è:

‚úÖ **–ü–æ–ø—ã—Ç–æ–∫ –¥–æ—Å—Ç—É–ø–∞ –∫ —á—É–∂–∏–º –∑–∞–∫–∞–∑–∞–º:**
```php
if ($user->isLogist() && $model->assigned_logist != $user->id) {
    Yii::warning('–ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —á—É–∂–æ–º—É –∑–∞–∫–∞–∑—É: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #' . $user->id . ' –∫ –∑–∞–∫–∞–∑—É #' . $id, 'security');
    throw new NotFoundHttpException('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω.');
}
```

‚úÖ **–ò–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–æ–≤:**
```php
Yii::info('–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ #' . $id . ' –∏–∑–º–µ–Ω–µ–Ω —Å "' . $oldStatus . '" –Ω–∞ "' . $newStatus . '" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º #' . $user->id, 'order');
```

‚úÖ **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–π –ª–æ–≥–∏—Å—Ç–æ–≤:**
```php
Yii::info('–õ–æ–≥–∏—Å—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ –∑–∞–∫–∞–∑ #' . $id . ': —Å—Ç–∞—Ä—ã–π=' . $oldLogist . ', –Ω–æ–≤—ã–π=' . $logistId, 'order');
```

‚úÖ **–ó–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤:**
```php
Yii::info('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã –¥–ª—è –∑–∞–∫–∞–∑–∞ #' . $model->id . ' (—Ç–æ–∫–µ–Ω: ' . $token . ')', 'order');
```

‚úÖ **–ü–æ–ø—ã—Ç–æ–∫ –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π:**
```php
Yii::warning('–ü–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–µ–∑ –ø—Ä–∞–≤: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #' . $user->id, 'security');
```

‚úÖ **Rate limiting:**
```php
Yii::warning('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è —Ç–æ–∫–µ–Ω–∞: ' . $token, 'security');
```

**–§–∞–π–ª—ã:**
- `controllers/AdminController.php` (—Å—Ç—Ä–æ–∫–∏ 157, 236, 258, 261, 276, 286, 440)
- `controllers/OrderController.php` (—Å—Ç—Ä–æ–∫–∏ 121, 138, 211)
- `models/Order.php` (—Å—Ç—Ä–æ–∫–∏ 214, 217, 221)

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** ‚úÖ –ü–æ–ª–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ —É–ª—É—á—à–µ–Ω–∏–π

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- **–î–æ:** 3 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏, 0 –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- **–ü–æ—Å–ª–µ:** 0 —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π, –ø–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–£–ª—É—á—à–µ–Ω–∏–µ:** +100% –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- **–î–æ:** –í–æ–∑–º–æ–∂–Ω—ã race conditions, –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö
- **–ü–æ—Å–ª–µ:** –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- **–£–ª—É—á—à–µ–Ω–∏–µ:** +100% –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- **–î–æ:** –ù–µ—Ç –ª–æ–≥–æ–≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **–ü–æ—Å–ª–µ:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (info, warning, error)
- **–£–ª—É—á—à–µ–Ω–∏–µ:** +100% –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏

### –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- **–î–æ:** API –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –Ω–æ–≤—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö
- **–ü–æ—Å–ª–µ:** –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π API + fallback
- **–£–ª—É—á—à–µ–Ω–∏–µ:** +100% —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ª–æ–≥–æ–≤ –≤ `config/web.php`:
```php
'log' => [
    'targets' => [
        [
            'class' => 'yii\log\FileTarget',
            'levels' => ['error', 'warning'],
            'categories' => ['security'],
            'logFile' => '@runtime/logs/security.log',
        ],
        [
            'class' => 'yii\log\FileTarget',
            'levels' => ['info', 'error'],
            'categories' => ['order'],
            'logFile' => '@runtime/logs/orders.log',
        ],
    ],
],
```

### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –Ω–∞:
- –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ rate limit (–±–æ–ª–µ–µ 10 —Ä–∞–∑ –≤ —á–∞—Å)
- –ü–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ —á—É–∂–∏–º –∑–∞–∫–∞–∑–∞–º (–ª—é–±–∞—è)
- –û—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ email (–±–æ–ª–µ–µ 5 –≤ —á–∞—Å)
- –û—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ (–±–æ–ª–µ–µ 3 –≤ —á–∞—Å)

### 3. –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
- –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –∞—É–¥–∏—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- –ö–≤–∞—Ä—Ç–∞–ª—å–Ω—ã–π –ø–µ–Ω—Ç–µ—Å—Ç

### 4. Backup
- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π backup –ë–î
- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π backup —Ñ–∞–π–ª–æ–≤ `/web/uploads/`
- –•—Ä–∞–Ω–µ–Ω–∏–µ 30 –¥–Ω–µ–π

---

## ‚úÖ Checklist –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

- [x] –í—Å–µ —Ñ–∞–π–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
- [x] –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- [x] CSRF-–∑–∞—â–∏—Ç–∞ –≤–∫–ª—é—á–µ–Ω–∞
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] Rate limiting –∞–∫—Ç–∏–≤–µ–Ω
- [x] –°—Ç–∞—Ç—É—Å—ã —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ staging
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] –ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã

**Senior Full-Stack Team**  
Email: dev-team@sneakerculture.by  
Slack: #dev-security

---

**–û—Ç—á–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω:** 25 –æ–∫—Ç—è–±—Ä—è 2025, 12:10  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** Production Ready ‚úÖ
