# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–ú–ü–û–†–¢–ê - –ì–û–¢–û–í–û

**–î–∞—Ç–∞**: 05.11.2024, 06:08

---

## 1. ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ê –û–®–ò–ë–ö–ê –≤ brand.php

### –ü—Ä–æ–±–ª–µ–º–∞
```
PHP Warning ‚Äì yii\base\ErrorException
Undefined array key "products_count"
–≤ /Users/user/CascadeProjects/splitwise/views/catalog/brand.php:53
```

### –†–µ—à–µ–Ω–∏–µ
**–ë–´–õ–û**:
```php
<span class="count">(<?= $category['products_count'] ?>)</span>
```

**–°–¢–ê–õ–û**:
```php
<span class="count">(<?= $category['count'] ?? 0 ?>)</span>
```

**–ü—Ä–∏—á–∏–Ω–∞**: –í `CatalogController::getFiltersData()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–ª–∏–∞—Å `COUNT(...) as count`, –∞ –Ω–µ `products_count`.

---

## 2. ‚úÖ –°–û–ó–î–ê–ù–ê –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø –ü–û –ú–ê–ü–ü–ò–ù–ì–£ –ü–û–õ–ï–ô

**–§–∞–π–ª**: `–ü–û–õ–Ø_JSON_–ú–ê–ü–ü–ò–ù–ì.md`

### –ß—Ç–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON**:
- 23 –ø–æ–ª—è –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º —Ç–æ–≤–∞—Ä–µ
- 10 –ø–æ–ª–µ–π –≤ children (–≤–∞—Ä–∏–∞–Ω—Ç—ã)
- properties[] —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏
- sizes[] —Å —Ä–∞–∑–º–µ—Ä–Ω—ã–º–∏ —Å–µ—Ç–∫–∞–º–∏

**–¢–µ–∫—É—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ**:
- ‚úÖ Product: 18/23 –ø–æ–ª–µ–π (78%)
- ‚úÖ ProductSize: 7/10 –ø–æ–ª–µ–π (70%)
- ‚úÖ ProductImage: 100%

---

## 3. ‚ö†Ô∏è –û–ë–ù–ê–†–£–ñ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### –ù–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è

1. **vat** (–ù–î–°) - "NO_VAT"
2. **currency** (–≤–∞–ª—é—Ç–∞) - "RUR"
3. **relatedProducts** (–ø–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã)
4. **timeDelivery** (—Å—Ä–æ–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏) - **–í–ê–ñ–ù–û!**
5. **params[–¶–≤–µ—Ç]** –∏–∑ children (—Ü–≤–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞)

### –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

**properties** —Å–æ–¥–µ—Ä–∂–∏—Ç –¥—É–±–ª–∏:
- "–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—Ç–∏–ª—è" = vendorCode (—É–∂–µ –µ—Å—Ç—å)
- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ JSON, –Ω–æ –ù–ï –ø–∞—Ä—Å—è—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è

### –ü–∞—Ä—Å–∏–Ω–≥ properties

**–¢–ï–ö–£–©–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –•–û–†–û–®–ê–Ø** ‚úÖ

–£–∂–µ –ø–∞—Ä—Å—è—Ç—Å—è:
- ‚úÖ –¢–∏–ø –∑–∞–∫—Ä—ã—Ç–∏—è ‚Üí `fastening`
- ‚úÖ –í—ã—Å–æ—Ç–∞ –≥–æ–ª–µ–Ω–∏—â–∞ ‚Üí `height`
- ‚úÖ –ü—Ä–∏–º–µ–Ω–∏–º—ã–π —Å–µ–∑–æ–Ω ‚Üí `season`
- ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç ‚Üí `color_description`
- ‚úÖ –†–µ–ª–∏–∑ –°–≤–∏–¥–∞–Ω–∏–µ ‚Üí `release_year`
- ‚úÖ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—Ç–∏–ª—è ‚Üí `style_code`
- ‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ ‚Üí `upper_material`
- ‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª –ø–æ–¥–æ—à–≤—ã ‚Üí `sole_material`

**–ú–µ—Ç–æ–¥—ã –º–∞–ø–ø–∏–Ω–≥–∞ –µ—Å—Ç—å**:
- `mapGender()` ‚úÖ
- `mapFastening()` ‚úÖ
- `mapHeight()` ‚úÖ
- `mapSeason()` ‚úÖ
- `extractYear()` ‚úÖ

---

## 4. üîß –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ

### –ö—Ä–∏—Ç–∏—á–Ω–æ (–¥–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è)

#### 4.1. –°–æ—Ö—Ä–∞–Ω—è—Ç—å —Å—Ä–æ–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏

**–ü—Ä–æ–±–ª–µ–º–∞**: timeDelivery –µ—Å—Ç—å –≤ –∫–∞–∂–¥–æ–º child, –Ω–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ**:
```php
// –í importSizes(), –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è ProductSize
if (!empty($childData['timeDelivery'])) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ/–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è Product
    if (!$product->delivery_time_min || 
        $childData['timeDelivery']['min'] < $product->delivery_time_min) {
        $product->delivery_time_min = $childData['timeDelivery']['min'];
    }
    if (!$product->delivery_time_max || 
        $childData['timeDelivery']['max'] > $product->delivery_time_max) {
        $product->delivery_time_max = $childData['timeDelivery']['max'];
    }
}

// –°–æ—Ö—Ä–∞–Ω—è–µ–º product –≤ –∫–æ–Ω—Ü–µ –∏–º–ø–æ—Ä—Ç–∞ —Ä–∞–∑–º–µ—Ä–æ–≤
$product->save(false);
```

---

#### 4.2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å sizes[] –¥–ª—è lookup

**–ü—Ä–æ–±–ª–µ–º–∞**: –°–µ–π—á–∞—Å —Ä–∞–∑–º–µ—Ä—ã –ø–∞—Ä—Å—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ `children[].params[–†–∞–∑–º–µ—Ä]`. –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –∏–∑–º–µ–Ω–∏—Ç—Å—è, —Ä–∞–∑–º–µ—Ä—ã –ø–æ—Ç–µ—Ä—è—é—Ç—Å—è.

**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `product.sizes_data` –∫–∞–∫ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫:

```php
private function importSizes($product, $children)
{
    // –°–æ–∑–¥–∞–µ–º lookup –∏–∑ sizes_data
    $sizesLookup = [];
    if ($product->sizes_data) {
        $sizesData = json_decode($product->sizes_data, true);
        
        // –°—Ç—Ä–æ–∏–º –∫–∞—Ä—Ç—É: —Ä–∞–∑–º–µ—Ä ‚Üí –≤—Å–µ —Å–∏—Å—Ç–µ–º—ã
        $euSizes = [];
        $usSizes = [];
        $ukSizes = [];
        $cmSizes = [];
        
        foreach ($sizesData as $sizeGrid) {
            $name = mb_strtolower($sizeGrid['name']);
            $values = explode(',', $sizeGrid['value']);
            
            if (strpos($name, '–µ–≤—Ä–æ–ø') !== false || strpos($name, 'eu') !== false) {
                $euSizes = array_map('trim', $values);
            }
            if (strpos($name, '—Å—à–∞') !== false || strpos($name, 'us') !== false) {
                $usSizes = array_map('trim', $values);
            }
            if (strpos($name, '–∞–Ω–≥–ª') !== false || strpos($name, 'uk') !== false) {
                $ukSizes = array_map('trim', $values);
            }
            if (strpos($name, '–∫–∏—Ç–∞–π') !== false || strpos($name, 'chn') !== false) {
                $cmSizes = array_map('trim', $values);
            }
        }
        
        // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å –ø–æ –ª—é–±–æ–π —Å–∏—Å—Ç–µ–º–µ
        $count = max(count($euSizes), count($usSizes), count($ukSizes), count($cmSizes));
        for ($i = 0; $i < $count; $i++) {
            $key = $usSizes[$i] ?? $euSizes[$i] ?? $i;
            $sizesLookup[$key] = [
                'eu' => $euSizes[$i] ?? null,
                'us' => $usSizes[$i] ?? null,
                'uk' => $ukSizes[$i] ?? null,
                'cm' => $cmSizes[$i] ?? null,
            ];
        }
    }
    
    // –¢–µ–ø–µ—Ä—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ ProductSize –∏—Å–ø–æ–ª—å–∑—É–µ–º lookup
    foreach ($children as $childData) {
        $sizeValue = $this->extractSizeFromParams($childData['params']);
        
        $size = new ProductSize();
        $size->product_id = $product->id;
        $size->size = $sizeValue;
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å –≤ lookup, –∑–∞–ø–æ–ª–Ω—è–µ–º –≤—Å–µ —Å–∏—Å—Ç–µ–º—ã
        if (isset($sizesLookup[$sizeValue])) {
            $size->us_size = $sizesLookup[$sizeValue]['us'];
            $size->eu_size = $sizesLookup[$sizeValue]['eu'];
            $size->uk_size = $sizesLookup[$sizeValue]['uk'];
            $size->cm_size = $sizesLookup[$sizeValue]['cm'];
        }
        
        // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
    }
}
```

---

### –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ (—É–ª—É—á—à–µ–Ω–∏–µ)

#### 4.3. –°–æ—Ö—Ä–∞–Ω—è—Ç—å —Ü–≤–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞

**–î–æ–±–∞–≤–∏—Ç—å –≤ ProductSize**:
```sql
ALTER TABLE product_size ADD COLUMN color VARCHAR(100) AFTER size;
```

**–í –∫–æ–¥–µ**:
```php
foreach ($childData['params'] as $param) {
    if (strpos(mb_strtolower($param['key']), '—Ü–≤–µ—Ç') !== false) {
        $size->color = $param['value'];
    }
}
```

---

#### 4.4. –°–æ—Ö—Ä–∞–Ω—è—Ç—å vat, currency

**–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è**:
```sql
ALTER TABLE product ADD COLUMN vat VARCHAR(50);
ALTER TABLE product ADD COLUMN currency VARCHAR(10) DEFAULT 'BYN';
```

**–í –∏–º–ø–æ—Ä—Ç–µ**:
```php
$product->vat = $data['vat'] ?? null;
$product->currency = $data['currency'] ?? 'BYN';
```

---

#### 4.5. –ò–º–ø–æ—Ä—Ç relatedProducts

**–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É**:
```sql
CREATE TABLE product_related (
    product_id INT NOT NULL,
    related_product_id INT NOT NULL,
    created_at DATETIME,
    PRIMARY KEY (product_id, related_product_id),
    FOREIGN KEY (product_id) REFERENCES product(id) ON DELETE CASCADE,
    FOREIGN KEY (related_product_id) REFERENCES product(id) ON DELETE CASCADE
);
```

**–í –∏–º–ø–æ—Ä—Ç–µ**:
```php
if (!empty($data['relatedProducts'])) {
    foreach ($data['relatedProducts'] as $relatedPoizonId) {
        $relatedProduct = Product::find()
            ->where(['poizon_id' => $relatedPoizonId])
            ->one();
        
        if ($relatedProduct) {
            Yii::$app->db->createCommand()->insert('product_related', [
                'product_id' => $product->id,
                'related_product_id' => $relatedProduct->id,
                'created_at' => date('Y-m-d H:i:s'),
            ])->execute();
        }
    }
}
```

---

## 5. ‚úÖ –ß–¢–û –£–ñ–ï –†–ê–ë–û–¢–ê–ï–¢ –û–¢–õ–ò–ß–ù–û

### –ü–∞—Ä—Å–∏–Ω–≥ properties
- ‚úÖ 8 —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è
- ‚úÖ –ú–µ—Ç–æ–¥—ã –º–∞–ø–ø–∏–Ω–≥–∞ –¥–ª—è –≤—Å–µ—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–∏—Ö –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö –Ω–∞–∑–≤–∞–Ω–∏–π

### –ò–º–ø–æ—Ä—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- ‚úÖ –í—Å–µ —Ñ–æ—Ç–æ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è
- ‚úÖ –ü–µ—Ä–≤–æ–µ = –≥–ª–∞–≤–Ω–æ–µ
- ‚úÖ –ü—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ CDN

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤
- ‚úÖ 4 —Ç–æ–≤–∞—Ä–∞ –≤–º–µ—Å—Ç–æ 61
- ‚úÖ 61 —Ä–∞–∑–º–µ—Ä —á–µ—Ä–µ–∑ ProductSize
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å–≤—è–∑—å product ‚Üí sizes

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥–∞—à–±–æ—Ä–¥–æ–º
- ‚úÖ ImportBatch —Å–æ–∑–¥–∞–µ—Ç—Å—è
- ‚úÖ ImportLog –¥–ª—è –æ—à–∏–±–æ–∫
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ summary (JSON)
- ‚úÖ –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–∞—à–±–æ—Ä–¥

---

## 6. üéØ –ü–†–ò–û–†–ò–¢–ï–¢–´ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ
1. ‚úÖ ~~–û—à–∏–±–∫–∞ products_count~~ - **–ò–°–ü–†–ê–í–õ–ï–ù–û**

### üü° –í–∞–∂–Ω–æ (—Ç–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞)
2. ‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ timeDelivery (15-24 –¥–Ω—è) - **–ù–£–ñ–ù–û –î–û–ë–ê–í–ò–¢–¨**
3. ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ sizes[] –¥–ª—è lookup - **–ù–£–ñ–ù–û –£–õ–£–ß–®–ò–¢–¨**

### üü¢ –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ
4. –¶–≤–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞ –≤ ProductSize
5. vat, currency –≤ Product
6. relatedProducts —á–µ—Ä–µ–∑ —Å–≤—è–∑—å

---

## 7. üìù –ò–¢–û–ì

### –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- ‚úÖ –û—à–∏–±–∫–∞ `products_count` –≤ brand.php
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –º–∞–ø–ø–∏–Ω–≥—É –ø–æ–ª–µ–π

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ
- ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ 8 —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∏–∑ properties
- ‚úÖ –ò–º–ø–æ—Ä—Ç –≤—Å–µ—Ö —Ñ–æ—Ç–æ
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤ (4 + 61 —Ä–∞–∑–º–µ—Ä–æ–≤)
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥–∞—à–±–æ—Ä–¥–æ–º

### –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å
- ‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ timeDelivery (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞)
- ‚ö†Ô∏è –£–ª—É—á—à–µ–Ω–∏–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ sizes[]
- üü¢ –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: vat, currency, relatedProducts, color

---

## 8. üöÄ –ö–ê–ö –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–¢–¨

### –û—à–∏–±–∫–∞ brand.php
```
1. –û—Ç–∫—Ä–æ–π—Ç–µ /catalog/brand/nike
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ - –Ω–µ—Ç –æ—à–∏–±–æ–∫
3. –§–∏–ª—å—Ç—Ä—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —Ä–∞–±–æ—Ç–∞—é—Ç
```

### –ò–º–ø–æ—Ä—Ç –ø–æ–ª–µ–π
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–º–ø–æ—Ä—Ç
php yii poizon-import-json/run "URL"

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –ë–î
mysql -u root order_management -e "
SELECT 
    name,
    fastening,
    height,
    season,
    color_description,
    release_year,
    style_code
FROM product 
WHERE poizon_id IS NOT NULL 
LIMIT 5
"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- fastening = "laces"
- height = "low"
- season = "all"
- color_description = "–ë–µ–ª—ã–π"
- release_year = "2024"
- style_code = "355152-106"

---

**–ì–æ—Ç–æ–≤–æ!** –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –≤—ã—è–≤–ª–µ–Ω—ã –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –ü–∞—Ä—Å–∏–Ω–≥ properties —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ. ‚úÖ
